import{createChromaMaterial}from"/ar/chroma-video.js";import{GLTFLoader}from"/ar/GLTFLoader.js";window.cameraFacing=!1;var mediaRecorder,mindarThree=null,hashLocation="",refresh=!1,resetAudio=!1,recFrameId=null,recordedChunks=[],videoBlob=null,videoMimeType="video/webm; codecs=vp8",videoExt=".webm";let frameRate=30,loadVideo=function(o,a){return new Promise((e,t)=>{let n=document.createElement("video");n.addEventListener("loadedmetadata",()=>{n.setAttribute("loop",!0),n.setAttribute("playsinline",!0),n.setAttribute("muted",!0),n.setAttribute("poster",a),console.log("Finished loading: "+o),e(n)}),n.src=o+"#t=0.1",n.preload="metadata"})},loadGLTF=function(n){return new Promise((t,e)=>{(new GLTFLoader).load(n,e=>{console.log("Finished loading: "+n),t(e)})})},loadAudio=function(n){return new Promise((t,e)=>{(new window.MINDAR.IMAGE.THREE.AudioLoader).load(n,e=>{console.log("Finished loading: "+n),t(e)})})},setup=async function(){showSplash();let{renderer:t,scene:n,camera:o}=mindarThree=new window.MINDAR.IMAGE.MindARThree({container:document.body,imageTargetSrc:artwork.marker,uiLoading:"no",uiScanning:"yes",uiError:"yes",filterMinCF:1e-4,filterBeta:.001,missTolerance:0,warmupTolerance:10}),a=mindarThree.addAnchor(0);if("video"==artwork.type&&artwork.video){artwork.videoElement=await loadVideo(artwork.video,artwork.poster);var e=new window.MINDAR.IMAGE.THREE.VideoTexture(artwork.videoElement),r=new window.MINDAR.IMAGE.THREE.PlaneGeometry(1,artwork.height/artwork.width),e=null==artwork.chroma||"null"==artwork.chroma?new window.MINDAR.IMAGE.THREE.MeshBasicMaterial({map:e}):createChromaMaterial(e,artwork.chroma),r=new window.MINDAR.IMAGE.THREE.Mesh(r,e);a.group.add(r)}else{if("model"!=artwork.type||!artwork.model)return void alert("CRITICAL: NO RESOURCE TO DISPLAY");e=new window.MINDAR.IMAGE.THREE.HemisphereLight(16777215,12303359,1);n.add(e),artwork.modelElement=await loadGLTF(artwork.model),artwork.modelElement.scene.scale.set(.1,.1,.1),artwork.modelElement.scene.position.set(0,-.4,0),a.group.add(artwork.modelElement.scene),artwork.mixerElement=new window.MINDAR.IMAGE.THREE.AnimationMixer(artwork.modelElement.scene),artwork.mixerElement.clipAction(artwork.modelElement.animations[0]).play()}artwork.audio&&loadAudio(artwork.audio).then(function(e){var t=new window.MINDAR.IMAGE.THREE.AudioListener;o.add(t),artwork.audioElement=new window.MINDAR.IMAGE.THREE.PositionalAudio(t),a.group.add(artwork.audioElement),artwork.audioElement.setBuffer(e),artwork.audioElement.setRefDistance(100),artwork.audioElement.setLoop(!0)}),a.onTargetFound=()=>{artwork.videoElement&&(artwork.videoElement.currentTime=0,artwork.videoElement.play()),artwork.audioElement&&artwork.audioElement.play(),saveMetrics("targetfound")},a.onTargetLost=()=>{artwork.videoElement&&artwork.videoElement.pause(),artwork.audioElement&&artwork.audioElement.stop(),mindarThree.ui.showScanning(),saveMetrics("targetlost")};let i=new window.MINDAR.IMAGE.THREE.Clock;await mindarThree.start(),t.setAnimationLoop(()=>{var e;artwork.mixerElement&&(e=i.getDelta(),artwork.mixerElement.update(e)),t.render(n,o)}),hideSplash()},start=async function(){mindarThree&&(await mindarThree.start(),hideSplash())},stop=async function(){if(mindarThree){showSplash(),await mindarThree.stop(),artwork.videoElement&&artwork.videoElement.pause(),artwork.audioElement&&artwork.audioElement.stop();for(let e=0;e<mindarThree.anchors.length;e++)mindarThree.anchors[e].group.visible=!1,mindarThree.anchors[e].group.updateWorldMatrix(null)}},restart=async function(){stop(),start()};function copyRenderedCanvas(e){var{video:t,renderer:n,scene:o,camera:a}=mindarThree,r=n.domElement,i=e.getContext("2d"),d=(e.width=r.width,e.height=r.height,(t.clientWidth-r.clientWidth)/2*t.videoWidth/t.clientWidth),l=(t.clientHeight-r.clientHeight)/2*t.videoHeight/t.clientHeight,s=t.videoWidth-2*d,c=t.videoHeight-2*l;i.drawImage(t,d,l,s,c,0,0,e.width,e.height),n.preserveDrawingBuffer=!0,n.render(o,a),i.drawImage(r,0,0,e.width,e.height),n.preserveDrawingBuffer=!1}function saveMetrics(e){""!=uuid&&fetch("/metrics",{method:"POST",body:JSON.stringify({metricType:e,id:artwork.id,data:window.navigator.userAgent||"Nothing",uuid:uuid}),headers:{Accept:"application/json","Content-Type":"application/json"}})}function showSplash(){document.getElementById("splash").style.display="flex"}function hideSplash(){document.getElementById("splash").style.display="none"}function showMuteBtn(){document.getElementById("soundBtn").style.display="none",document.getElementById("muteBtn").style.display="block"}function hideMuteBtn(){document.getElementById("soundBtn").style.display="block",document.getElementById("muteBtn").style.display="none"}function showVideo(){document.getElementById("videoWrapper").style.display="flex",document.getElementById("arBtnsWrapper").style.display="none",document.getElementById("videoBtnsWrapper").style.display="flex"}function hideVideo(){showPlayBtn();var e=document.getElementById("videoWrapper");e.style.display="none",e.innerHTML="",document.getElementById("videoBtnsWrapper").style.display="none",document.getElementById("arBtnsWrapper").style.display="flex"}function showRecBtn(){document.getElementById("recVideoBtn").style.display="block",document.getElementById("stopRecVideoBtn").style.display="none"}function hideRecBtn(){document.getElementById("recVideoBtn").style.display="none",document.getElementById("stopRecVideoBtn").style.display="block"}function showPlayBtn(){document.getElementById("playVideoBtn").style.display="block",document.getElementById("stopVideoBtn").style.display="none"}function hidePlayBtn(){document.getElementById("playVideoBtn").style.display="none",document.getElementById("stopVideoBtn").style.display="block"}document.addEventListener("DOMContentLoaded",async function(){MediaRecorder.isTypeSupported("video/webm; codecs=vp8")||(videoMimeType="video/mp4;codecs:h264",videoExt=".mp4"),window.cameraFacing=localStorage.getItem("cameraFacing"),window.location.hash="",setup(),document.getElementById("switchBtn").addEventListener("click",function(){window.cameraFacing="user"==window.cameraFacing?"environment":"user",localStorage.setItem("cameraFacing",window.cameraFacing),restart()}),document.getElementById("soundBtn")&&(document.getElementById("soundBtn").addEventListener("click",function(){artwork.audioElement&&(artwork.audioElement.setVolume(0),showMuteBtn())}),document.getElementById("muteBtn").addEventListener("click",function(){artwork.audioElement&&(artwork.audioElement.setVolume(1),hideMuteBtn())})),document.getElementById("recVideoBtn").addEventListener("click",function(){hideRecBtn(),recordedChunks=[],videoBlob=null;let e=document.getElementById("record"),n=(copyRenderedCanvas(e),e.toDataURL());var t,o=e.captureStream(frameRate);(mediaRecorder=artwork.audioElement?(t=artwork.audioElement.context.createMediaStreamDestination(),artwork.audioElement.listener.getInput().connect(t),artwork.audioElement.gain.connect(t),t=new MediaStream([...o.getVideoTracks(),...t.stream.getAudioTracks()]),new MediaRecorder(t,{mimeType:videoMimeType})):new MediaRecorder(o,{mimeType:videoMimeType})).onerror=e=>{console.log(e),showRecBtn()},mediaRecorder.addEventListener("dataavailable",function(e){0<e.data.size&&recordedChunks.push(e.data)}),mediaRecorder.addEventListener("stop",function(){if(0!=recordedChunks.length){videoBlob=new Blob(recordedChunks,{type:videoMimeType});var t=URL.createObjectURL(videoBlob);let e=document.createElement("video");e.addEventListener("loadedmetadata",()=>{e.setAttribute("id","videoCanvas"),e.setAttribute("loop","true"),e.setAttribute("playsinline","true"),e.setAttribute("poster",n),document.getElementById("videoWrapper").appendChild(e),showVideo(),showRecBtn(),artwork.audioElement&&artwork.audioElement.getVolume()&&(artwork.audioElement.setVolume(0),resetAudio=!0),hashLocation=Date.now(),window.location.hash=hashLocation}),e.src=t,e.preload="metadata",saveMetrics("recvideo")}}),mediaRecorder.start(),recFrameId=setInterval(function(){copyRenderedCanvas(e)},1e3/frameRate)}),document.getElementById("stopRecVideoBtn").addEventListener("click",function(){clearInterval(recFrameId),recFrameId=null,mediaRecorder.stop()}),document.getElementById("backVideoBtn").addEventListener("click",function(){history.back()}),document.getElementById("playVideoBtn").addEventListener("click",function(){hidePlayBtn();var e=document.getElementById("videoCanvas");e.loop=!0,e.playsinline=!0,e.muted=!1,e.play()}),document.getElementById("stopVideoBtn").addEventListener("click",function(){showPlayBtn();var e=document.getElementById("videoCanvas");e.pause(),e.muted=!0}),document.getElementById("shareVideoBtn").addEventListener("click",function(){var e={mimeType:videoMimeType},t=videoExt,t=(artwork.tagline+"-"+hashLocation+t).replace(/[/\\?%*:|"<>]/g,"-"),t=[new File([videoBlob],t,e)];if(navigator.canShare&&navigator.canShare({files:t}))try{navigator.share({files:t,title:artwork.tagline,text:artwork.tagline,url:"https://wallmurals.ai"}).catch(e=>{console.log(e)}),saveMetrics("sharevideo")}catch(e){console.error("Error sharing video:",e)}})}),screen.orientation.addEventListener("change",function(e){""!=window.location.hash?refresh=!refresh:restart()}),window.addEventListener("pageshow",function(e){e.persisted&&window.location.reload()}),window.addEventListener("hashchange",function(){""==window.location.hash&&(refresh&&(refresh=!1,restart()),artwork.audioElement&&resetAudio&&(resetAudio=!1,artwork.audioElement.setVolume(1)),hideVideo())});