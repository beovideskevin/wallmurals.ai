import{createChromaMaterial}from"/ar/chroma-video.js";import{GLTFLoader}from"/ar/GLTFLoader.js";let ttl=18e5;var ready=!1,mindarThree=null,elements=[],hashLocation="",refresh=!1,isMuted=!0,currentlyPlayingVideo=null,currentlyPlayingAudio=null;let frameRate=30;var recFrameId=null,mediaRecorder=null,canvas=null,poster=null,audioCtx=null,source=null,destination=null,streamArray=[],recordedChunks=[],videoBlob=null,recVideo=null,mediaRecOptions=null;let recording=!1,muxer=null,videoEncoder=null,audioEncoder=null,startTime=null,audioTrack=null,lastKeyFrame=null,framesGenerated=0;var videoMimeType="video/webm";let photoMimeType="image/png",shutter=new Audio("/assets/sounds/shutter.mp3");var sparkImageData=null,sparkIndex=0;let sparkFilters=[{filter:()=>window.ImageFilters.Enrich(sparkImageData)},{filter:()=>window.ImageFilters.BrightnessContrastPhotoshop(sparkImageData,-20,20)},{filter:()=>window.ImageFilters.BrightnessContrastPhotoshop(sparkImageData,20,-10)},{filter:()=>window.ImageFilters.Posterize(sparkImageData,32)},{filter:()=>window.ImageFilters.Emboss(sparkImageData)},{filter:()=>window.ImageFilters.Sepia(sparkImageData)},{filter:()=>window.ImageFilters.GrayScale(sparkImageData)},{filter:()=>sparkImageData}],loadVideo=function(a,o){return new Promise((e,t)=>{let n=document.createElement("video");n.addEventListener("loadedmetadata",()=>{n.setAttribute("loop",""),n.setAttribute("playsInline",""),n.setAttribute("muted",""),n.setAttribute("poster",o),console.log("Finished loading: "+a),e(n)}),n.src=a,n.preload="metadata"})},loadGLTF=function(n){return new Promise((t,e)=>{(new GLTFLoader).load(n,e=>{console.log("Finished loading: "+n),t(e)})})},setup=async function(){showSplash();let{renderer:n,scene:a,camera:o}=mindarThree=new window.MINDAR.IMAGE.MindARThree({container:document.body,imageTargetSrc:artwork.target,uiLoading:"no",uiScanning:"yes",uiError:"yes",filterMinCF:1e-4,filterBeta:.001,missTolerance:3,warmupTolerance:10});var e=new window.MINDAR.IMAGE.THREE.HemisphereLight(16777215,12303359,1);a.add(e);for(let o=0;o<artwork.animations.length;o++){let a=mindarThree.addAnchor(o);elements[o]={videoElement:null,mixerElement:null,audioElement:null},artwork.animations[o].audio&&(showSoundBtn(),elements[o].audioElement=new Audio(artwork.animations[o].audio)),artwork.animations[o].video&&loadVideo(artwork.animations[o].video,artwork.animations[o].poster).then(function(e){var t=new window.MINDAR.IMAGE.THREE.VideoTexture(e),n=new window.MINDAR.IMAGE.THREE.PlaneGeometry(1,artwork.animations[o].height/artwork.animations[o].width),t=null==artwork.animations[o].chroma||"null"==artwork.animations[o].chroma?new window.MINDAR.IMAGE.THREE.MeshBasicMaterial({map:t}):createChromaMaterial(t,artwork.animations[o].chroma),n=new window.MINDAR.IMAGE.THREE.Mesh(n,t);a.group.add(n),elements[o].videoElement=e,elements[o].videoElement.muted=!0,a.onTargetFound=()=>{""==window.location.hash&&(elements[o].videoElement&&(currentlyPlayingVideo=elements[o].videoElement,elements[o].videoElement.play()),elements[o].audioElement&&(currentlyPlayingAudio=elements[o].audioElement,isMuted||elements[o].audioElement.play()),saveMetrics("targetfound"))},a.onTargetLost=()=>{elements[o].videoElement&&elements[o].videoElement.pause(),elements[o].audioElement&&(currentlyPlayingAudio=null,elements[o].audioElement.pause()),mindarThree.ui.showScanning(),saveMetrics("targetlost")}}),artwork.animations[o].model&&loadGLTF(artwork.animations[o].model).then(function(e){e.scene.scale.set(.1,.1,.1),e.scene.position.set(0,-.4,0),a.group.add(e.scene);var t=new window.MINDAR.IMAGE.THREE.AnimationMixer(e.scene);t.clipAction(e.animations[0]).play(),elements[o].mixerElement=t,a.onTargetFound=()=>{""==window.location.hash&&(elements[o].audioElement&&(currentlyPlayingAudio=elements[o].audioElement,isMuted||elements[o].audioElement.play()),saveMetrics("targetfound"))},a.onTargetLost=()=>{elements[o].audioElement&&(currentlyPlayingAudio=null,elements[o].audioElement.pause()),mindarThree.ui.showScanning(),saveMetrics("targetlost")}})}await mindarThree.start();let i=new window.MINDAR.IMAGE.THREE.Clock;n.setAnimationLoop(()=>{var e,t=i.getDelta();for(e of elements)e.mixerElement&&e.mixerElement.update(t);n.render(a,o)}),refresh&&(refresh=!1,restart()),ready=!0,hideSplash()},start=async function(){mindarThree&&(await mindarThree.start(),hideSplash())},stop=async function(){mindarThree&&(showSplash(),await mindarThree.stop())},restart=function(){stop(),start()};function resizeCanvas(){window.innerWidth>window.innerHeight?(canvas.width=1920,canvas.height=1080):(canvas.width=1080,canvas.height=1920)}function copyRenderedCanvas(e){var{video:t,renderer:n,scene:a,camera:o}=mindarThree,i=n.domElement,r=new OffscreenCanvas(i.width,i.height),d=r.getContext("2d"),s=(t.clientWidth-i.clientWidth)/2*t.videoWidth/t.clientWidth,l=(t.clientHeight-i.clientHeight)/2*t.videoHeight/t.clientHeight,c=t.videoWidth-2*s,m=t.videoHeight-2*l,t=(d.drawImage(t,s,l,c,m,0,0,i.width,i.height),n.preserveDrawingBuffer=!0,n.render(a,o),d.drawImage(i,0,0,i.width,i.height),n.preserveDrawingBuffer=!1,e.getContext("2d"));let u=16*i.width/9,h=i.width,p=0,y=(i.height-u)/2;i.width>i.height&&(h=16*i.height/9,u=i.height,p=(i.width-h)/2,y=0),t.drawImage(r,p,y,h,u,0,0,e.width,e.height)}function createAndShowVideo(){var e=URL.createObjectURL(videoBlob);(recVideo=document.createElement("video")).addEventListener("loadedmetadata",()=>{recVideo.setAttribute("id","videoCanvas"),recVideo.setAttribute("loop","true"),recVideo.setAttribute("playsinline","true"),recVideo.setAttribute("poster",poster),document.getElementById("videoWrapper").appendChild(recVideo),showVideo(),hashLocation=Date.now(),window.location.hash=hashLocation,saveMetrics("recvideo")}),recVideo.src=e,recVideo.preload="metadata"}function saveMetrics(e){""!=uuid&&fetch("/metrics",{method:"POST",body:JSON.stringify({metricType:e,id:artwork._id,data:window.navigator.userAgent||"Nothing",uuid:uuid}),headers:{Accept:"application/json","Content-Type":"application/json"}})}function showSplash(){document.getElementById("splash").style.display="flex"}function hideSplash(){document.getElementById("splash").style.display="none"}function showSoundBtn(){document.getElementById("noSoundBtn").style.display="none",document.getElementById("muteBtn").style.display="block"}function showMuteBtn(){document.getElementById("soundBtn").style.display="none",document.getElementById("muteBtn").style.display="block"}function hideMuteBtn(){document.getElementById("muteBtn").style.display="none",document.getElementById("soundBtn").style.display="block"}function showPhoto(){document.getElementById("photoWrapper").style.display="flex",document.getElementById("arBtnsWrapper").style.display="none",document.getElementById("photoBtnsWrapper").style.display="flex"}function hidePhoto(){var e=document.getElementById("photoWrapper");e.style.display="none",e.innerHTML="",document.getElementById("photoBtnsWrapper").style.display="none"}function showVideo(){document.getElementById("videoWrapper").style.display="flex",document.getElementById("arBtnsWrapper").style.display="none",document.getElementById("videoBtnsWrapper").style.display="flex"}function hideVideo(){var e=document.getElementById("videoWrapper");e.style.display="none",e.innerHTML="",document.getElementById("videoBtnsWrapper").style.display="none"}function showARHideAll(){showPlayBtn(),hideVideo(),hidePhoto(),document.getElementById("arBtnsWrapper").style.display="flex"}function showRecBtn(){document.getElementById("stopRecVideoBtn").style.display="none",document.getElementById("recVideoBtn").style.display="block"}function hideRecBtn(){document.getElementById("recVideoBtn").style.display="none",document.getElementById("stopRecVideoBtn").style.display="block"}function showPlayBtn(){document.getElementById("stopVideoBtn").style.display="none",document.getElementById("playVideoBtn").style.display="block"}function hidePlayBtn(){document.getElementById("playVideoBtn").style.display="none",document.getElementById("stopVideoBtn").style.display="block"}function setWithExpiry(e,t){t={value:t,expiry:(new Date).getTime()+ttl};localStorage.setItem(e,JSON.stringify(t))}function getWithExpiry(e){var t=localStorage.getItem(e);if(!t)return null;try{var n=JSON.parse(t);return(new Date).getTime()>n.expiry?(localStorage.removeItem(e),null):n.value}catch(e){return console.log("Invalid item in storage:",t),null}}document.addEventListener("DOMContentLoaded",async function(){if(MediaRecorder.isTypeSupported("video/webm; codecs=vp9")?mediaRecOptions={mimeType:"video/webm; codecs=vp9"}:MediaRecorder.isTypeSupported("video/webm")?mediaRecOptions={mimeType:"video/webm"}:MediaRecorder.isTypeSupported("video/mp4")?(mediaRecOptions={mimeType:"video/mp4"},videoMimeType="video/mp4"):(console.error("no suitable mimetype found for this device"),document.getElementById("recVideoBtn").style.display="none"),canvas=document.createElement("canvas"),resizeCanvas(),window.location.hash="",artwork=artwork||getWithExpiry("artwork"))saveMetrics("open"),setup();else{let t=document.getElementById("locError"),n=document.getElementById("muralsError");navigator.geolocation?navigator.geolocation.getCurrentPosition(async function(e){var t=e.coords.latitude,e=e.coords.longitude,t=await fetch(`/ar/location/${t}/${e}/`+uuid);t.ok&&200==t.status&&(e=await t.json())?(setWithExpiry("artwork",artwork=e),saveMetrics("open"),setup()):n.style.display="flex"},function(e){t.style.display="flex"},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}):(console.log("Geolocation is not supported by this browser?"),t.style.display="flex")}function a(){var e=document.timeline.currentTime-startTime,t=new VideoFrame(canvas,{timestamp:1e6*framesGenerated/frameRate,duration:1e6/frameRate}),n=(framesGenerated++,5e3<=e-lastKeyFrame);n&&(lastKeyFrame=e),videoEncoder.encode(t,{keyFrame:n}),t.close()}document.getElementById("soundBtn").addEventListener("click",function(){isMuted=!0,currentlyPlayingAudio&&currentlyPlayingAudio.pause(),showMuteBtn()}),document.getElementById("muteBtn").addEventListener("click",function(){isMuted=!1,currentlyPlayingAudio&&currentlyPlayingAudio.play(),hideMuteBtn()}),document.getElementById("recVideoBtn").addEventListener("click",function(){if(audioCtx=audioCtx||new AudioContext,"video/webm"===videoMimeType){elements[0].audioElement&&(null===audioTrack&&(source=audioCtx.createMediaElementSource(elements[0].audioElement)).connect(audioCtx.destination),destination=audioCtx.createMediaStreamDestination(),source.connect(destination),audioTrack=destination.stream.getAudioTracks()[0]);var e=audioTrack?.getSettings().sampleRate,t=audioTrack?.getSettings().channelCount;muxer=new Mp4Muxer.Muxer({target:new Mp4Muxer.ArrayBufferTarget,video:{codec:"avc",width:canvas.width,height:canvas.height,frameRate:frameRate},audio:audioTrack?{codec:"aac",sampleRate:e,numberOfChannels:t}:void 0,fastStart:"in-memory",firstTimestampBehavior:"offset"}),(videoEncoder=new VideoEncoder({output:(e,t)=>muxer.addVideoChunk(e,t),error:e=>console.error(e)})).configure({codec:"avc1.424028",width:canvas.width,height:canvas.height,bitrate:1e6}),audioTrack&&((audioEncoder=new AudioEncoder({output:(e,t)=>muxer.addAudioChunk(e,t),error:e=>console.error(e)})).configure({codec:"mp4a.40.2",numberOfChannels:t,sampleRate:e,bitrate:128e3}),t=new MediaStreamTrackProcessor({track:audioTrack}),e=new WritableStream({write(e){recording&&(audioEncoder.encode(e),e.close())}}),t.readable.pipeTo(e)),startTime=document.timeline.currentTime,lastKeyFrame=-1/0,framesGenerated=0}else if(!mediaRecorder){var n,t=canvas.captureStream(frameRate);streamArray.push(...t.getVideoTracks());for(n of elements)(source=audioCtx.createMediaElementSource(n.audioElement)).connect(audioCtx.destination),destination=audioCtx.createMediaStreamDestination(),source.connect(destination),streamArray.push(...destination.stream.getAudioTracks());e=new MediaStream(streamArray);(mediaRecorder=new MediaRecorder(e,mediaRecOptions)).onerror=e=>{recording=!1,showRecBtn(),console.log(e),alert("There was an error recording the video :(")},mediaRecorder.addEventListener("dataavailable",function(e){0<e.data.size&&recordedChunks.push(e.data)}),mediaRecorder.addEventListener("stop",function(){0==recordedChunks.length?(console.log("No data was recorded!"),alert("There was an error recording the video :(")):(videoBlob=new Blob(recordedChunks,{type:videoMimeType}),createAndShowVideo())})}recording=!0,hideRecBtn(),recordedChunks=[],videoBlob=null,copyRenderedCanvas(canvas),poster=canvas.toDataURL(),"video/webm"===videoMimeType?a():mediaRecorder.start(),recFrameId=setInterval(function(){copyRenderedCanvas(canvas),"video/webm"===videoMimeType&&a()},1e3/frameRate)}),document.getElementById("stopRecVideoBtn").addEventListener("click",function(){clearInterval(recFrameId),recFrameId=null,recording=!1,showRecBtn(),"video/webm"===videoMimeType?(async()=>{audioTrack?.stop(),await videoEncoder?.flush(),await audioEncoder?.flush(),muxer.finalize();var e=muxer.target.buffer;videoBlob=new Blob([e]),createAndShowVideo(),videoEncoder=null,audioEncoder=null,muxer=null,startTime=null})():mediaRecorder.stop(),currentlyPlayingAudio&&currentlyPlayingAudio.pause()}),document.getElementById("backVideoBtn").addEventListener("click",function(){history.back()}),document.getElementById("playVideoBtn").addEventListener("click",function(){hidePlayBtn(),recVideo.muted=!1,recVideo.play()}),document.getElementById("stopVideoBtn").addEventListener("click",function(){showPlayBtn(),recVideo.pause(),recVideo.currentTime=0}),document.getElementById("shareVideoBtn").addEventListener("click",async function(){var e=(hashLocation+".mp4").replace(/[/\\?%*:|"<>]/g,"-"),e=new File([videoBlob],e,{type:videoMimeType});if(navigator.canShare&&navigator.canShare({files:[e]}))try{navigator.share({files:[e]}).catch(e=>{console.log("Error sharing video:",e)}),saveMetrics("sharevideo")}catch(e){console.error("Error navigator.canShare:",e),alert("Your device can not share the video.")}else alert("Your device can not share the video.")}),document.getElementById("photoBtn").addEventListener("click",function(){shutter.play();var e=document.createElement("canvas");e.setAttribute("id","photoCanvas"),e.width=window.innerWidth,e.height=window.innerHeight,copyRenderedCanvas(e);document.getElementById("photoWrapper").appendChild(e),showPhoto();var t=document.createElement("canvas"),n=(t.setAttribute("id","sparkPhoto"),t.getContext("2d"));t.width=e.width,t.height=e.height,n.drawImage(e,0,0,e.width,e.height),sparkImageData=n.getImageData(0,0,e.width,e.height),sparkIndex=0,hashLocation=Date.now(),window.location.hash=hashLocation,saveMetrics("photo")}),document.getElementById("backPhotoBtn").addEventListener("click",function(){history.back()}),document.getElementById("sparkPhotoBtn").addEventListener("click",function(){document.getElementById("photoCanvas").getContext("2d").putImageData(sparkFilters[sparkIndex].filter(),0,0),sparkIndex=++sparkIndex>=sparkFilters.length?0:sparkIndex}),document.getElementById("sharePhotoBtn").addEventListener("click",function(){document.getElementById("photoCanvas").toBlob(e=>{var t=(hashLocation+".png").replace(/[/\\?%*:|"<>]/g,"-"),e=new File([e],t,{type:photoMimeType});if(navigator.canShare&&navigator.canShare({files:[e]}))try{navigator.share({files:[e]}).catch(e=>{console.error("Error sharing photo:",e)}),saveMetrics("sharephoto")}catch(e){console.error("Error navigator.canShare:",e),alert("Your device can not share the photo.")}else alert("Your device can not share the photo.")})})}),screen.orientation.addEventListener("change",function(e){""!=window.location.hash||recording||!ready?refresh=!0:(resizeCanvas(),restart())}),window.addEventListener("pageshow",function(e){e.persisted&&window.location.reload()}),window.addEventListener("hashchange",function(){""==window.location.hash&&(refresh&&(refresh=!1,restart()),currentlyPlayingAudio&&!isMuted&&currentlyPlayingAudio.play(),showARHideAll())});