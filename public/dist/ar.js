import{createChromaMaterial}from"/ar/chroma-video.js";import{GLTFLoader}from"/ar/GLTFLoader.js";window.cameraFacing=!1;var mindarThree=null,elements=[],hashLocation="",refresh=!1,isMuted=!0,currentlyPlayingVideo=null,currentlyPlayingAudio=null,recFrameId=null,mediaRecorder=null,videoBlob=null,videoMimeType="video/webm; codecs=vp9,opus",videoMimeShare="video/webm",videoExt=".webm";let frameRate=30,ttl=18e5,loadVideo=function(i,o){return new Promise((e,t)=>{let n=document.createElement("video");n.addEventListener("loadedmetadata",()=>{n.setAttribute("loop",""),n.setAttribute("playsInline",""),n.setAttribute("muted",""),n.setAttribute("poster",o),console.log("Finished loading: "+i),e(n)}),n.src=i,n.preload="metadata"})},loadGLTF=function(n){return new Promise((t,e)=>{(new GLTFLoader).load(n,e=>{console.log("Finished loading: "+n),t(e)})})},setup=async function(){showSplash();let{renderer:n,scene:i,camera:o}=mindarThree=new window.MINDAR.IMAGE.MindARThree({container:document.body,imageTargetSrc:artwork.target,uiLoading:"no",uiScanning:"yes",uiError:"yes",filterMinCF:1e-4,filterBeta:.001,missTolerance:0,warmupTolerance:10});var e=new window.MINDAR.IMAGE.THREE.HemisphereLight(16777215,12303359,1);i.add(e);for(let o=0;o<artwork.animations.length;o++){let i=mindarThree.addAnchor(o);elements[o]={videoElement:null,mixerElement:null,audioElement:null},artwork.animations[o].audio&&(showSoundBtn(),elements[o].audioElement=new Audio(artwork.animations[o].audio),elements[o].audioElement.currentTime=0),artwork.animations[o].video&&loadVideo(artwork.animations[o].video,artwork.animations[o].poster).then(function(e){var t=new window.MINDAR.IMAGE.THREE.VideoTexture(e),n=new window.MINDAR.IMAGE.THREE.PlaneGeometry(1,artwork.animations[o].height/artwork.animations[o].width),t=null==artwork.animations[o].chroma||"null"==artwork.animations[o].chroma?new window.MINDAR.IMAGE.THREE.MeshBasicMaterial({map:t}):createChromaMaterial(t,artwork.animations[o].chroma),n=new window.MINDAR.IMAGE.THREE.Mesh(n,t);i.group.add(n),elements[o].videoElement=e,elements[o].videoElement.currentTime=0,elements[o].videoElement.muted=!0,i.onTargetFound=()=>{""==window.location.hash&&(elements[o].videoElement&&(currentlyPlayingVideo=elements[o].videoElement,elements[o].videoElement.currentTime=0,elements[o].videoElement.play()),elements[o].audioElement&&(currentlyPlayingAudio=elements[o].audioElement,elements[o].audioElement.currentTime=0,isMuted||elements[o].audioElement.play()),saveMetrics("targetfound"))},i.onTargetLost=()=>{elements[o].videoElement&&(currentlyPlayingVideo=null,elements[o].videoElement.pause(),elements[o].videoElement.currentTime=0),elements[o].audioElement&&(currentlyPlayingAudio=null,elements[o].audioElement.pause(),elements[o].audioElement.currentTime=0),mindarThree.ui.showScanning(),saveMetrics("targetlost")}}),artwork.animations[o].model&&loadGLTF(artwork.animations[o].model).then(function(e){e.scene.scale.set(.1,.1,.1),e.scene.position.set(0,-.4,0),i.group.add(e.scene);var t=new window.MINDAR.IMAGE.THREE.AnimationMixer(e.scene);t.clipAction(e.animations[0]).play(),elements[o].mixerElement=t,i.onTargetFound=()=>{""==window.location.hash&&(elements[o].audioElement&&(currentlyPlayingAudio=elements[o].audioElement,elements[o].audioElement.currentTime=0,isMuted||elements[o].audioElement.play()),saveMetrics("targetfound"))},i.onTargetLost=()=>{elements[o].audioElement&&(currentlyPlayingAudio=null,elements[o].audioElement.pause(),elements[o].audioElement.currentTime=0),mindarThree.ui.showScanning(),saveMetrics("targetlost")}})}await mindarThree.start();let a=new window.MINDAR.IMAGE.THREE.Clock;n.setAnimationLoop(()=>{var e,t=a.getDelta();for(e of elements)e.mixerElement&&e.mixerElement.update(t);n.render(i,o)}),hideSplash()};function copyRenderedCanvas(e){var{video:t,renderer:n,scene:i,camera:o}=mindarThree,a=n.domElement,r=e.getContext("2d"),d=(e.width=a.width,e.height=a.height,(t.clientWidth-a.clientWidth)/2*t.videoWidth/t.clientWidth),l=(t.clientHeight-a.clientHeight)/2*t.videoHeight/t.clientHeight,s=t.videoWidth-2*d,c=t.videoHeight-2*l;r.drawImage(t,d,l,s,c,0,0,e.width,e.height),n.preserveDrawingBuffer=!0,n.render(i,o),r.drawImage(a,0,0,e.width,e.height),n.preserveDrawingBuffer=!1}function saveMetrics(e){""!=uuid&&fetch("/metrics",{method:"POST",body:JSON.stringify({metricType:e,id:artwork._id,data:window.navigator.userAgent||"Nothing",uuid:uuid}),headers:{Accept:"application/json","Content-Type":"application/json"}})}function showSplash(){document.getElementById("splash").style.display="flex"}function hideSplash(){document.getElementById("splash").style.display="none"}function showSoundBtn(){document.getElementById("noSoundBtn").style.display="none",document.getElementById("muteBtn").style.display="block"}function showMuteBtn(){document.getElementById("soundBtn").style.display="none",document.getElementById("muteBtn").style.display="block"}function hideMuteBtn(){document.getElementById("muteBtn").style.display="none",document.getElementById("soundBtn").style.display="block"}function showVideo(){document.getElementById("videoWrapper").style.display="flex",document.getElementById("arBtnsWrapper").style.display="none",document.getElementById("videoBtnsWrapper").style.display="flex"}function hideVideo(){showPlayBtn();var e=document.getElementById("videoWrapper");e.style.display="none",e.innerHTML="",document.getElementById("videoBtnsWrapper").style.display="none",document.getElementById("arBtnsWrapper").style.display="flex"}function showRecBtn(){document.getElementById("stopRecVideoBtn").style.display="none",document.getElementById("recVideoBtn").style.display="block"}function hideRecBtn(){document.getElementById("recVideoBtn").style.display="none",document.getElementById("stopRecVideoBtn").style.display="block"}function showPlayBtn(){document.getElementById("stopVideoBtn").style.display="none",document.getElementById("playVideoBtn").style.display="block"}function hidePlayBtn(){document.getElementById("playVideoBtn").style.display="none",document.getElementById("stopVideoBtn").style.display="block"}function setWithExpiry(e,t){t={value:t,expiry:(new Date).getTime()+ttl};localStorage.setItem(e,JSON.stringify(t))}function getWithExpiry(e){var t=localStorage.getItem(e);if(!t)return null;try{var n=JSON.parse(t);return(new Date).getTime()>n.expiry?(localStorage.removeItem(e),null):n.value}catch(e){return console.log("Invalid item in storage:",t),null}}document.addEventListener("DOMContentLoaded",async function(){if(MediaRecorder.isTypeSupported(videoMimeType)||(videoMimeType="video/webm; codecs=avc1,opus",videoMimeShare="video/webm",MediaRecorder.isTypeSupported(videoMimeType))||(videoMimeType="video/mp4;codecs:h264",videoMimeShare="video/mp4",videoExt=".mp4"),window.cameraFacing=getWithExpiry("cameraFacing"),window.location.hash="",artwork=artwork||getWithExpiry("artwork"))console.log("from storage",artwork),setup();else{let t=document.getElementById("locError");navigator.geolocation?navigator.geolocation.getCurrentPosition(async function(e){var t=e.coords.latitude,e=e.coords.longitude,t=await fetch(`/ar/location/${t}/${e}/`+uuid);t.ok&&200==t.status&&(e=await t.json())?(setWithExpiry("artwork",artwork=e),setup()):(alert("There are no augmented reality murals in your area."),window.location="https://www.wallmurals.ai/home")},function(e){t.style.display="flex"},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}):(console.log("Geolocation is not supported by this browser?"),t.style.display="flex")}document.getElementById("switchBtn").addEventListener("click",function(){window.cameraFacing="user"==window.cameraFacing?"environment":"user",setWithExpiry("cameraFacing",window.cameraFacing),window.location.reload()}),document.getElementById("soundBtn").addEventListener("click",function(){isMuted=!0,currentlyPlayingAudio&&(currentlyPlayingAudio.pause(),currentlyPlayingAudio.currentTime=0),showMuteBtn()}),document.getElementById("muteBtn").addEventListener("click",function(){isMuted=!1,currentlyPlayingAudio&&(currentlyPlayingAudio.currentTime=0,currentlyPlayingAudio.play()),hideMuteBtn()}),document.getElementById("recVideoBtn").addEventListener("click",function(){hideRecBtn(),videoBlob=null;let n=[],e=document.getElementById("record");var t=[...e.captureStream(frameRate).getVideoTracks()];copyRenderedCanvas(e);let i=e.toDataURL();var o,a=new AudioContext;for(o of elements){var r=a.createMediaElementSource(o.audioElement),d=(r.connect(a.destination),a.createMediaStreamDestination());r.connect(d),t.push(...d.stream.getAudioTracks())}var l=new MediaStream(t);(mediaRecorder=new MediaRecorder(l,{mimeType:videoMimeType})).onerror=e=>{console.log(e),showRecBtn()},mediaRecorder.addEventListener("dataavailable",function(e){0<e.data.size&&n.push(e.data)}),mediaRecorder.addEventListener("stop",function(){if(showRecBtn(),0==n.length)console.log("No data was recorded!");else{videoBlob=new Blob(n,{type:videoMimeType});var t=URL.createObjectURL(videoBlob);let e=document.createElement("video");e.addEventListener("loadedmetadata",()=>{e.setAttribute("id","videoCanvas"),e.setAttribute("loop","true"),e.setAttribute("playsinline","true"),e.setAttribute("poster",i),document.getElementById("videoWrapper").appendChild(e),showVideo(),isMuted=!0,currentlyPlayingAudio&&(currentlyPlayingAudio.pause(),currentlyPlayingAudio.currentTime=0),hashLocation=Date.now(),window.location.hash=hashLocation}),e.src=t,e.preload="metadata",saveMetrics("recvideo")}}),mediaRecorder.start(),recFrameId=setInterval(function(){copyRenderedCanvas(e)},1e3/frameRate)}),document.getElementById("stopRecVideoBtn").addEventListener("click",function(){clearInterval(recFrameId),recFrameId=null,mediaRecorder.stop()}),document.getElementById("backVideoBtn").addEventListener("click",function(){history.back()}),document.getElementById("playVideoBtn").addEventListener("click",function(){hidePlayBtn();var e=document.getElementById("videoCanvas");e.loop=!0,e.playsinline=!0,e.muted=!1,e.play()}),document.getElementById("stopVideoBtn").addEventListener("click",function(){showPlayBtn();var e=document.getElementById("videoCanvas");e.currentTime=0,e.muted=!0,e.pause()}),document.getElementById("shareVideoBtn").addEventListener("click",function(){var e=(hashLocation+videoExt).replace(/[/\\?%*:|"<>]/g,"-"),e=[new File([videoBlob],e,{type:videoMimeShare})];if(navigator.canShare&&navigator.canShare({files:e}))try{navigator.share({files:e,title:artwork.tagline,text:artwork.tagline,url:artwork.website}).catch(e=>{console.log("Error sharing video:",e),alert("Your device can not share the video.")}),saveMetrics("sharevideo")}catch(e){console.error("Error navigator.canShare:",e),alert("Your device can not share the video.")}})}),screen.orientation.addEventListener("change",function(e){""!=window.location.hash?refresh=!refresh:window.location.reload()}),window.addEventListener("pageshow",function(e){e.persisted&&window.location.reload()}),window.addEventListener("hashchange",function(){""==window.location.hash&&(refresh&&(refresh=!1,window.location.reload()),isMuted=!1,currentlyPlayingAudio&&(currentlyPlayingAudio.currentTime=0,currentlyPlayingAudio.play()),currentlyPlayingVideo&&(currentlyPlayingVideo.currentTime=0),hideVideo())});