import{createChromaMaterial}from"/assets/ar/chroma-video.js";import{GLTFLoader}from"/assets/ar/GLTFLoader.js";let ttl=18e5;var ready=!1,onTarget=!1,mindarThree=null,elements=[],hashLocation="",refresh=!1,currentlyPlayingVideo=null,currentlyPlayingAudio=null,isMuted=!0,itHasSound=!1;let frameRate=30,vSmallSide=720,vLongSide=1280;var mediaRecOptions={mimeType:"video/mp4; codecs=avc1.42001f, mp4a.40.2"},videoMimeType="video/mp4",videoExt=".mp4",isRecording=!1,recFrameId=null,mediaRecorder=null,canvas=null,canvasContext=null,copyCanvas=null,copyContext=null,poster=null,audioCtx=null,source=null,destination=null,streamArray=[],recordedChunks=[],videoBlob=null,recVideo=null,worker=null,photoCanvas=null;let photoMimeType="image/png",shutter=new Audio("/assets/sounds/shutter.mp3"),loadVideo=function(o,a){return new Promise((e,t)=>{let n=document.createElement("video");n.addEventListener("loadedmetadata",()=>{n.setAttribute("loop",""),n.setAttribute("playsInline",""),n.setAttribute("muted",""),n.setAttribute("poster",a),console.log("Finished loading: "+o),e(n)}),n.src=o,n.preload="metadata"})},loadGLTF=function(n){return new Promise((t,e)=>{(new GLTFLoader).load(n,e=>{console.log("Finished loading: "+n),t(e)})})},setup=async function(){showSplash();var e={container:document.body,imageTargetSrc:artwork.target,uiLoading:"no",uiScanning:"yes",uiError:"yes",filterMinCF:artwork.animations[0].video?vFilterMinCF:filterMinCF,filterBeta:artwork.animations[0].video?vFilterBeta:filterBeta,missTolerance:artwork.animations[0].video?vMissTolerance:missTolerance,warmupTolerance:artwork.animations[0].video?vWarmupTolerance:warmupTolerance},e=(mindarThree=new window.MINDAR.IMAGE.MindARThree(e)).scene,t=new window.MINDAR.IMAGE.THREE.HemisphereLight(16777215,12303359,1);e.add(t);for(let d=0;d<artwork.animations.length;d++){let r=mindarThree.addAnchor(d);elements[d]={videoElement:null,modelElement:null,mixerElement:null,audioElement:null},artwork.animations[d].audio&&(itHasSound=!0,showSoundBtn(),elements[d].audioElement=new Audio(artwork.animations[d].audio)),artwork.animations[d].video&&loadVideo(artwork.animations[d].video,artwork.animations[d].poster).then(function(e){var t=new window.MINDAR.IMAGE.THREE.VideoTexture(e);let n=1;artwork.animations[d].scale&&(n=artwork.animations[d].scale);var o,a,i=new window.MINDAR.IMAGE.THREE.PlaneGeometry(n,n*(artwork.animations[d].height/artwork.animations[d].width)),t=null==artwork.animations[d].chroma||"null"==artwork.animations[d].chroma||""==artwork.animations[d].chroma?new window.MINDAR.IMAGE.THREE.MeshBasicMaterial({map:t}):createChromaMaterial(t,artwork.animations[d].chroma),i=new window.MINDAR.IMAGE.THREE.Mesh(i,t);artwork.animations[d].position&&([t,o,a]=artwork.animations[d].position.split(","),i.rotation.x=t,i.position.y=o,i.position.z=a),r.group.add(i),elements[d].videoElement=e,elements[d].videoElement.muted=!0,r.onTargetFound=()=>{onTarget=!0,""==window.location.hash&&(elements[d].videoElement&&(currentlyPlayingVideo=elements[d].videoElement,elements[d].videoElement.play()),elements[d].audioElement&&(currentlyPlayingAudio=elements[d].audioElement,isMuted||elements[d].audioElement.play()),hideScanning(),saveMetrics("targetfound"))},r.onTargetLost=()=>{onTarget=!1,elements[d].videoElement&&elements[d].videoElement.pause(),elements[d].audioElement&&(currentlyPlayingAudio=null,elements[d].audioElement.pause()),showScanning(),saveMetrics("targetlost")}}),artwork.animations[d].model&&loadGLTF(artwork.animations[d].model).then(function(e){var t,n,o;artwork.animations[d].scale?(t=artwork.animations[d].scale,e.scene.scale.set(t,t,t)):e.scene.scale.set(.1,.1,.1),artwork.animations[d].position?([t,n,o]=artwork.animations[d].position.split(","),e.scene.position.set(t,n,o)):e.scene.position.set(0,0,0),artwork.animations[d].rotation&&([t,n,o]=artwork.animations[d].rotation.split(","),e.scene.rotation.set(t,n,o)),r.group.add(e.scene);let a=null;e.animations.length&&(a=new window.MINDAR.IMAGE.THREE.AnimationMixer(e.scene)).clipAction(e.animations[0]).play(),elements[d].mixerElement=a,elements[d].modelElement=e,r.onTargetFound=()=>{onTarget=!0,""==window.location.hash&&(elements[d].audioElement&&(currentlyPlayingAudio=elements[d].audioElement,isMuted||elements[d].audioElement.play()),hideScanning(),saveMetrics("targetfound"))},r.onTargetLost=()=>{onTarget=!1,elements[d].audioElement&&(currentlyPlayingAudio=null,elements[d].audioElement.pause()),showScanning(),saveMetrics("targetlost")}})}start(),refresh&&(refresh=!1,restart())},start=async function(){if(mindarThree){let{renderer:n,scene:o,camera:a}=mindarThree,i=(await mindarThree.start(),new window.MINDAR.IMAGE.THREE.Clock);n.setAnimationLoop(()=>{var e,t=i.getDelta();for(e of elements)e.mixerElement&&e.mixerElement.update(t);n.render(o,a)}),hideSplash(),ready=!0}},stop=function(){mindarThree&&(ready=!1,showSplash(),currentlyPlayingVideo&&currentlyPlayingVideo.pause(),currentlyPlayingAudio&&currentlyPlayingAudio.pause(),mindarThree.stop(),mindarThree.renderer.setAnimationLoop(null))},restart=function(){stop(),start()};function InitRefreshRecCanvas(){canvas=document.createElement("canvas"),window.innerWidth>window.innerHeight?(canvas.width=vLongSide,canvas.height=vSmallSide):(canvas.width=vSmallSide,canvas.height=vLongSide),canvasContext=canvas.getContext("2d",{desynchronized:!0});var e=mindarThree.renderer;copyCanvas=new OffscreenCanvas(e.domElement.width,e.domElement.height),copyContext=copyCanvas.getContext("2d")}function copyRenderedCanvas(e){var{video:t,renderer:n,scene:o,camera:a}=mindarThree,i=n.domElement,r=(t.clientWidth-i.clientWidth)/2*t.videoWidth/t.clientWidth,d=(t.clientHeight-i.clientHeight)/2*t.videoHeight/t.clientHeight;e.drawImage(t,r,d,t.videoWidth-2*r,t.videoHeight-2*d,0,0,i.width,i.height),n.preserveDrawingBuffer=!0,n.render(o,a),e.drawImage(i,0,0,i.width,i.height),n.preserveDrawingBuffer=!1}function resizeAndCopyCopy(){let e=copyCanvas.height*canvas.width/copyCanvas.width,t=canvas.width,n=0,o=(canvas.height-e)/2;copyCanvas.width>copyCanvas.height&&(t=copyCanvas.width*canvas.height/copyCanvas.height,e=canvas.height,n=(canvas.width-t)/2,o=0),canvasContext.drawImage(copyCanvas,0,0,copyCanvas.width,copyCanvas.height,n,o,t,e)}function createAndShowVideo(){var e=URL.createObjectURL(videoBlob);(recVideo=document.createElement("video")).addEventListener("loadedmetadata",()=>{recVideo.setAttribute("id","videoCanvas"),recVideo.setAttribute("loop","true"),recVideo.setAttribute("playsinline","true"),recVideo.setAttribute("poster",poster),document.getElementById("videoWrapper").appendChild(recVideo),showVideo(),hashLocation=Date.now(),window.location.hash=hashLocation,saveMetrics("recvideo")}),recVideo.src=e,recVideo.preload="metadata"}function saveMetrics(e){""!=uuid&&fetch("/metrics",{method:"POST",body:JSON.stringify({metricType:e,id:artwork._id,data:window.navigator.userAgent||"Nothing",uuid:uuid}),headers:{Accept:"application/json","Content-Type":"application/json"}})}function showSplash(){document.getElementById("splash").style.display="flex"}function hideSplash(){document.getElementById("splash").style.display="none"}function showScanning(){isRecording||(document.getElementById("arBtnsWrapper").style.display="none"),mindarThree.ui.showScanning()}function hideScanning(){document.getElementById("arBtnsWrapper").style.display="flex"}function showSoundBtn(){document.getElementById("noSoundBtn").style.display="none",document.getElementById("muteBtn").style.display="block"}function showMuteBtn(){document.getElementById("soundBtn").style.display="none",document.getElementById("muteBtn").style.display="block"}function hideMuteBtn(){document.getElementById("muteBtn").style.display="none",document.getElementById("soundBtn").style.display="block"}function showDownloadBtn(){document.getElementById("shareVideoBtn").style.display="none",document.getElementById("downloadVideoBtn").style.display="block"}function showPhoto(){document.getElementById("photoWrapper").style.display="flex",document.getElementById("arBtnsWrapper").style.display="none",document.getElementById("photoBtnsWrapper").style.display="flex"}function hidePhoto(){var e=document.getElementById("photoWrapper");e.style.display="none",e.innerHTML="",document.getElementById("photoBtnsWrapper").style.display="none"}function showVideo(){document.getElementById("videoWrapper").style.display="flex",document.getElementById("arBtnsWrapper").style.display="none",document.getElementById("videoBtnsWrapper").style.display="flex"}function hideVideo(){var e=document.getElementById("videoWrapper");e.style.display="none",e.innerHTML="",document.getElementById("videoBtnsWrapper").style.display="none"}function showARHideAll(){showPlayBtn(),hideVideo(),hidePhoto()}function showRecBtn(){document.getElementById("stopRecVideoBtn").style.display="none",document.getElementById("recVideoBtn").style.display="block"}function hideRecBtn(){document.getElementById("recVideoBtn").style.display="none",document.getElementById("stopRecVideoBtn").style.display="block"}function showPlayBtn(){document.getElementById("stopVideoBtn").style.display="none",document.getElementById("playVideoBtn").style.display="block"}function hidePlayBtn(){document.getElementById("playVideoBtn").style.display="none",document.getElementById("stopVideoBtn").style.display="block"}function setWithExpiry(e,t){t={value:t,expiry:(new Date).getTime()+ttl};localStorage.setItem(e,JSON.stringify(t))}function getWithExpiry(e){var t=localStorage.getItem(e);if(!t)return null;try{var n=JSON.parse(t);return(new Date).getTime()>n.expiry?(localStorage.removeItem(e),null):n.value}catch(e){return console.log("Invalid item in storage:",t),null}}document.addEventListener("DOMContentLoaded",async function(){if(window.location.hash="",artwork=artwork||getWithExpiry("artwork"))saveMetrics("open"),setup();else{let t=document.getElementById("locError"),n=document.getElementById("muralsError");navigator.geolocation?navigator.geolocation.getCurrentPosition(async function(e){var t=e.coords.latitude,e=e.coords.longitude,t=await fetch(`/ar/location/${t}/${e}/`+uuid);t.ok&&200==t.status&&(e=await t.json())?(setWithExpiry("artwork",artwork=e),saveMetrics("open"),setup()):n.style.display="flex"},function(e){t.style.display="flex"},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}):(console.log("Geolocation is not supported by this browser?"),t.style.display="flex")}document.getElementById("soundBtn").addEventListener("click",function(){isMuted=!0,currentlyPlayingAudio&&currentlyPlayingAudio.pause(),showMuteBtn()}),document.getElementById("muteBtn").addEventListener("click",function(){isMuted=!1,currentlyPlayingAudio&&currentlyPlayingAudio.play(),hideMuteBtn()}),document.getElementById("recVideoBtn").addEventListener("click",function(){if(onTarget&&!isRecording){InitRefreshRecCanvas(),recordedChunks=[],videoBlob=null,audioCtx=audioCtx||new AudioContext;var e,t=canvas.captureStream(frameRate);streamArray=[...t.getVideoTracks()];for(e of elements)e.audioElement&&(null==source&&(source=audioCtx.createMediaElementSource(e.audioElement)).connect(audioCtx.destination),destination=audioCtx.createMediaStreamDestination(),source.connect(destination),streamArray.push(...destination.stream.getAudioTracks()));t=new MediaStream(streamArray);(mediaRecorder=new MediaRecorder(t,mediaRecOptions)).onerror=e=>{isRecording=!1,showRecBtn(),console.log(e),alert("There was an error recording the video :(")},mediaRecorder.addEventListener("dataavailable",function(e){0<e.data.size&&recordedChunks.push(e.data)}),mediaRecorder.addEventListener("stop",function(){0==recordedChunks.length?(console.log("No data was recorded!"),alert("There was an error recording the video :(")):(videoBlob=new Blob(recordedChunks,{type:videoMimeType}),createAndShowVideo())}),isMuted&&itHasSound&&(isMuted=!1,currentlyPlayingAudio&&currentlyPlayingAudio.play(),hideMuteBtn()),copyRenderedCanvas(copyContext),resizeAndCopyCopy(),poster=canvas.toDataURL(),isRecording=!0,hideRecBtn(),mediaRecorder.start(),recFrameId=setInterval(function(){copyRenderedCanvas(copyContext),resizeAndCopyCopy()},1e3/frameRate)}}),document.getElementById("stopRecVideoBtn").addEventListener("click",function(){clearInterval(recFrameId),recFrameId=null,isRecording=!1,showRecBtn(),mediaRecorder.stop(),currentlyPlayingAudio&&currentlyPlayingAudio.pause()}),document.getElementById("backVideoBtn").addEventListener("click",function(){history.back()}),document.getElementById("playVideoBtn").addEventListener("click",function(){hidePlayBtn(),recVideo.muted=!1,recVideo.play()}),document.getElementById("stopVideoBtn").addEventListener("click",function(){showPlayBtn(),recVideo.pause(),recVideo.currentTime=0}),document.getElementById("shareVideoBtn").addEventListener("click",async function(){var e=(artwork.tagline.replace(/\s/g,"-")+"-"+hashLocation+videoExt).replace(/[/\\?%*:|"<>]/g,"-"),e=new File([videoBlob],e,{type:videoMimeType});if(navigator.canShare&&navigator.canShare({files:[e]}))try{navigator.share({files:[e]}).catch(e=>{console.log("Error sharing video:",e)}),saveMetrics("sharevideo")}catch(e){console.error("Error navigator.canShare:",e),alert("Your device can not share the video.")}else alert("Your device can not share the video.")}),document.getElementById("downloadVideoBtn").addEventListener("click",function(){var e=URL.createObjectURL(videoBlob),t=document.createElement("a");t.href=e;var n=(artwork.tagline.replace(/\s/g,"-")+"-"+hashLocation+videoExt).replace(/[/\\?%*:|"<>]/g,"-");t.download=n,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e)}),document.getElementById("photoBtn").addEventListener("click",function(){var e;onTarget&&!isRecording&&((photoCanvas=document.createElement("canvas")).setAttribute("id","photoCanvas"),e=mindarThree.renderer,photoCanvas.width=e.domElement.width,photoCanvas.height=e.domElement.height,copyRenderedCanvas(photoCanvas.getContext("2d")),document.getElementById("photoWrapper").appendChild(photoCanvas),showPhoto(),currentlyPlayingAudio&&currentlyPlayingAudio.pause(),shutter.play(),hashLocation=Date.now(),window.location.hash=hashLocation,saveMetrics("photo"))}),document.getElementById("backPhotoBtn").addEventListener("click",function(){history.back()}),document.getElementById("downloadPhotoBtn").addEventListener("click",function(){var e=photoCanvas.toDataURL("image/jpeg",1),t=document.createElement("a"),n=(artwork.tagline.replace(/\s/g,"-")+"-"+hashLocation).replace(/[/\\?%*:|"<>]/g,"-");t.download=n+".jpg",t.href=e,t.click(),t.remove()}),document.getElementById("sharePhotoBtn").addEventListener("click",function(){document.getElementById("photoCanvas").toBlob(e=>{var t=(artwork.tagline.replace(/\s/g,"-")+"-"+hashLocation+".png").replace(/[/\\?%*:|"<>]/g,"-"),e=new File([e],t,{type:photoMimeType});if(navigator.canShare&&navigator.canShare({files:[e]}))try{navigator.share({files:[e]}).catch(e=>{console.error("Error sharing photo:",e)}),saveMetrics("sharephoto")}catch(e){console.error("Error navigator.canShare:",e),alert("Your device can not share the photo.")}else alert("Your device can not share the photo.")})})}),screen.orientation.addEventListener("change",function(){""!=window.location.hash||isRecording||!ready?refresh=!0:restart()}),window.addEventListener("pageshow",function(e){e.persisted&&(""!=window.location.hash&&(window.location.href=window.location.href.split("#")[0]),window.location.reload())}),window.addEventListener("hashchange",function(){""==window.location.hash&&(refresh&&(refresh=!1,restart()),currentlyPlayingAudio&&!isMuted&&currentlyPlayingAudio.play(),showARHideAll())});