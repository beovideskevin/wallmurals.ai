window.ImageFilters={},ImageFilters.utils={initSampleCanvas:function(){var t=document.createElement("canvas"),_=t.getContext("2d");t.width=0,t.height=0,this.getSampleCanvas=function(){return t},this.getSampleContext=function(){return _},this.createImageData=_.createImageData?function(t,$){return _.createImageData(t,$)}:function(t,_){return new ImageData(t,_)}},getSampleCanvas:function(){return this.initSampleCanvas(),this.getSampleCanvas()},getSampleContext:function(){return this.initSampleCanvas(),this.getSampleContext()},createImageData:function(t,_){return this.initSampleCanvas(),this.createImageData(t,_)},clamp:function(t){return t>255?255:t<0?0:t},buildMap:function(t){for(var _,$=[],a=0;a<256;a+=1)$[a]=(_=t(a))>255?255:_<0?0:0|_;return $},applyMap:function(t,_,$){for(var a=0,e=t.length;a<e;a+=4)_[a]=$[t[a]],_[a+1]=$[t[a+1]],_[a+2]=$[t[a+2]],_[a+3]=t[a+3]},mapRGB:function(t,_,$){this.applyMap(t,_,this.buildMap($))},getPixelIndex:function(t,_,$,a,e){if(t<0||t>=$||_<0||_>=a)switch(e){case 1:t=t<0?0:t>=$?$-1:t,_=_<0?0:_>=a?a-1:_;break;case 2:t=(t%=$)<0?t+$:t,_=(_%=a)<0?_+a:_;break;default:return null}return _*$+t<<2},getPixel:function(t,_,$,a,e,i){if(_<0||_>=a||$<0||$>=e)switch(i){case 1:_=_<0?0:_>=a?a-1:_,$=$<0?0:$>=e?e-1:$;break;case 2:_=(_%=a)<0?_+a:_,$=($%=e)<0?$+e:$;break;default:return 0}var r=$*a+_<<2;return t[r+3]<<24|t[r]<<16|t[r+1]<<8|t[r+2]},getPixelByIndex:function(t,_){return t[_+3]<<24|t[_]<<16|t[_+1]<<8|t[_+2]},copyBilinear:function(t,_,$,a,e,i,r,n){var h,u,o,s,l,g,f,c=_<0?_-1|0:0|_,d=$<0?$-1|0:0|$,v=_-c,m=$-d,F=0,p=0,w=0,I=0;if(c>=0&&c<a-1&&d>=0&&d<e-1){if(h=d*a+c<<2,v||m)F=t[h+3]<<24|t[h]<<16|t[h+1]<<8|t[h+2],h+=4,p=t[h+3]<<24|t[h]<<16|t[h+1]<<8|t[h+2],w=t[(h=h-8+(a<<2))+3]<<24|t[h]<<16|t[h+1]<<8|t[h+2],h+=4,I=t[h+3]<<24|t[h]<<16|t[h+1]<<8|t[h+2];else{i[r]=t[h],i[r+1]=t[h+1],i[r+2]=t[h+2],i[r+3]=t[h+3];return}}else if(F=this.getPixel(t,c,d,a,e,n),v||m)p=this.getPixel(t,c+1,d,a,e,n),w=this.getPixel(t,c,d+1,a,e,n),I=this.getPixel(t,c+1,d+1,a,e,n);else{i[r]=F>>16&255,i[r+1]=F>>8&255,i[r+2]=255&F,i[r+3]=F>>24&255;return}s=((F>>16&255)*(u=1-v)+(p>>16&255)*v)*(o=1-m)+((w>>16&255)*u+(I>>16&255)*v)*m,l=((F>>8&255)*u+(p>>8&255)*v)*o+((w>>8&255)*u+(I>>8&255)*v)*m,g=((255&F)*u+(255&p)*v)*o+((255&w)*u+(255&I)*v)*m,f=((F>>24&255)*u+(p>>24&255)*v)*o+((w>>24&255)*u+(I>>24&255)*v)*m,i[r]=s>255?255:s<0?0:0|s,i[r+1]=l>255?255:l<0?0:0|l,i[r+2]=g>255?255:g<0?0:0|g,i[r+3]=f>255?255:f<0?0:0|f},rgbToHsl:function(t,_,$){$/=255;var a=(t/=255)>(_/=255)?t>$?t:$:_>$?_:$,e=t<_?t<$?t:$:_<$?_:$,i=a-e,r=0,n=0,h=(e+a)/2;return 0!==i&&(r=t===a?(_-$)/i+(_<$?6:0):_===a?($-t)/i+2:(t-_)/i+4,r/=6,n=h>.5?i/(2-a-e):i/(a+e)),[r,n,h]},hslToRgb:function(t,_,$){var a,e,i,r,n,h,u=[];if(0===_)u=[r=n=h=255*$+.5|0,n,h];else{e=$<=.5?$*(_+1):$+_-$*_,a=2*$-e,i=t+1/3;for(var o,s=0;s<3;s+=1)i<0?i+=1:i>1&&(i-=1),o=6*i<1?a+(e-a)*i*6:2*i<1?e:3*i<2?a+(e-a)*(2/3-i)*6:a,u[s]=255*o+.5|0,i-=1/3}return u}},ImageFilters.Translate=function(t,_,$,a){},ImageFilters.Scale=function(t,_,$,a){},ImageFilters.Rotate=function(t,_,$,a,e,i){},ImageFilters.Affine=function(t,_,$,a){},ImageFilters.UnsharpMask=function(t,_){},ImageFilters.ConvolutionFilter=function(t,_,$,a,e,i,r,n,h,u){var o=t.data,s=t.width,l=t.height,g=(o.length,this.utils.createImageData(s,l)),f=g.data;e=e||1,i=i||0,!1!==r&&(r=!0),!1!==n&&(n=!0);for(var c=0,d=_>>1,v=$>>1,m=(h=h||0)>>16&255,F=h>>8&255,p=255&h,w=255*(u=u||0),I=0;I<l;I+=1)for(var D=0;D<s;D+=1,c+=4){for(var C,b=0,B=0,S=0,R=0,G=!1,P=0,k=-d;k<=d;k+=1){var M,T=I+k;0<=T&&T<l?M=T*s:n?M=I*s:G=!0;for(var z=-v;z<=v;z+=1){var E=a[P++];if(0!==E){var A=D+z;if(0<=A&&A<s||(n?A=D:G=!0),G)b+=E*m,B+=E*F,S+=E*p,R+=E*w;else{var H=M+A<<2;b+=E*o[H],B+=E*o[H+1],S+=E*o[H+2],R+=E*o[H+3]}}}}f[c]=(C=b/e+i)>255?255:C<0?0:0|C,f[c+1]=(C=B/e+i)>255?255:C<0?0:0|C,f[c+2]=(C=S/e+i)>255?255:C<0?0:0|C,f[c+3]=r?o[c+3]:(C=R/e+i)>255?255:C<0?0:0|C}return g},ImageFilters.Binarize=function(t,_){var $=t.data,a=t.width,e=t.height,i=$.length,r=this.utils.createImageData(a,e),n=r.data;isNaN(_)&&(_=.5),_*=255;for(var h=0;h<i;h+=4){var u=$[h]+$[h+1]+$[h+2]/3;n[h]=n[h+1]=n[h+2]=u<=_?0:255,n[h+3]=255}return r},ImageFilters.BlendAdd=function(t,_,$,a){for(var e,i=t.data,r=t.width,n=t.height,h=i.length,u=this.utils.createImageData(r,n),o=u.data,s=_.data,l=0;l<h;l+=4)o[l]=(e=i[l]+s[l])>255?255:e,o[l+1]=(e=i[l+1]+s[l+1])>255?255:e,o[l+2]=(e=i[l+2]+s[l+2])>255?255:e,o[l+3]=255;return u},ImageFilters.BlendSubtract=function(t,_,$,a){for(var e,i=t.data,r=t.width,n=t.height,h=i.length,u=this.utils.createImageData(r,n),o=u.data,s=_.data,l=0;l<h;l+=4)o[l]=(e=i[l]-s[l])<0?0:e,o[l+1]=(e=i[l+1]-s[l+1])<0?0:e,o[l+2]=(e=i[l+2]-s[l+2])<0?0:e,o[l+3]=255;return u},ImageFilters.BoxBlur=function(){var t=function(t,_,$,a,e){var i,r,n,h,u,o,s,l,g,f,c,d,v,m,F=2*e+1,p=e+1,w=$-1,I=0,D=[];for(g=0,f=256*F;g<f;g+=1)D[g]=g/F|0;for(d=0;d<a;d+=1){for(i=r=n=h=0,u=d,i+=p*t[o=I<<2],r+=p*t[o+1],n+=p*t[o+2],h+=p*t[o+3],g=1;g<=e;g+=1)i+=t[o=I+(g<$?g:w)<<2],r+=t[o+1],n+=t[o+2],h+=t[o+3];for(c=0;c<$;c+=1)_[o=u<<2]=D[i],_[o+1]=D[r],_[o+2]=D[n],_[o+3]=D[h],(v=c+p)>w&&(v=w),(m=c-e)<0&&(m=0),s=I+v<<2,l=I+m<<2,i+=t[s]-t[l],r+=t[s+1]-t[l+1],n+=t[s+2]-t[l+2],h+=t[s+3]-t[l+3],u+=a;I+=$}};return function(_,$,a,e){for(var i=_.data,r=_.width,n=_.height,h=(i.length,this.utils.createImageData(r,n)),u=h.data,o=this.utils.createImageData(r,n).data,s=0;s<e;s+=1)t(s?u:i,o,r,n,$),t(o,u,n,r,a);return h}}(),ImageFilters.GaussianBlur=function(t,_){var $,a,e;switch(_){case 2:$=5,a=[1,1,2,1,1,1,2,4,2,1,2,4,8,4,2,1,2,4,2,1,1,1,2,1,1],e=52;break;case 3:$=7,a=[1,1,2,2,2,1,1,1,2,2,4,2,2,1,2,2,4,8,4,2,2,2,4,8,16,8,4,2,2,2,4,8,4,2,2,1,2,2,4,2,2,1,1,1,2,2,2,1,1],e=140;break;case 4:$=15,a=[2,2,3,4,5,5,6,6,6,5,5,4,3,2,2,2,3,4,5,7,7,8,8,8,7,7,5,4,3,2,3,4,6,7,9,10,10,11,10,10,9,7,6,4,3,4,5,7,9,10,12,13,13,13,12,10,9,7,5,4,5,7,9,11,13,14,15,16,15,14,13,11,9,7,5,5,7,10,12,14,16,17,18,17,16,14,12,10,7,5,6,8,10,13,15,17,19,19,19,17,15,13,10,8,6,6,8,11,13,16,18,19,20,19,18,16,13,11,8,6,6,8,10,13,15,17,19,19,19,17,15,13,10,8,6,5,7,10,12,14,16,17,18,17,16,14,12,10,7,5,5,7,9,11,13,14,15,16,15,14,13,11,9,7,5,4,5,7,9,10,12,13,13,13,12,10,9,7,5,4,3,4,6,7,9,10,10,11,10,10,9,7,6,4,3,2,3,4,5,7,7,8,8,8,7,7,5,4,3,2,2,2,3,4,5,5,6,6,6,5,5,4,3,2,2],e=2044;break;default:$=3,a=[1,2,1,2,4,2,1,2,1],e=16}return this.ConvolutionFilter(t,$,$,a,e,0,!1)},ImageFilters.StackBlur=function(){var t=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],_=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function $(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}return function(a,e){var i,r,n,h,u,o,s,l,g,f,c,d,v,m,F,p,w,I,D,C,b,B,S,R,G,P,k,M=a.data,T=a.width,z=a.height,E=(M.length,this.Clone(a)),A=E.data,H=e+e+1,N=T-1,O=z-1,j=e+1,q=j*(j+1)/2,L=new $,U=L,J=t[e],K=_[e];for(n=1;n<H;n+=1)U=U.next=new $,n==j&&(k=U);for(r=0,U.next=L,s=o=0;r<z;r+=1){for(p=w=I=D=l=g=f=c=0,d=j*(C=A[o]),v=j*(b=A[o+1]),m=j*(B=A[o+2]),F=j*(S=A[o+3]),l+=q*C,g+=q*b,f+=q*B,c+=q*S,U=L,n=0;n<j;n+=1)U.r=C,U.g=b,U.b=B,U.a=S,U=U.next;for(n=1;n<j;n+=1)h=o+((N<n?N:n)<<2),l+=(U.r=C=A[h])*(R=j-n),g+=(U.g=b=A[h+1])*R,f+=(U.b=B=A[h+2])*R,c+=(U.a=S=A[h+3])*R,p+=C,w+=b,I+=B,D+=S,U=U.next;for(i=0,G=L,P=k;i<T;i+=1)A[o]=l*J>>K,A[o+1]=g*J>>K,A[o+2]=f*J>>K,A[o+3]=c*J>>K,l-=d,g-=v,f-=m,c-=F,d-=G.r,v-=G.g,m-=G.b,F-=G.a,h=s+((h=i+e+1)<N?h:N)<<2,p+=G.r=A[h],w+=G.g=A[h+1],I+=G.b=A[h+2],D+=G.a=A[h+3],l+=p,g+=w,f+=I,c+=D,G=G.next,d+=C=P.r,v+=b=P.g,m+=B=P.b,F+=S=P.a,p-=C,w-=b,I-=B,D-=S,P=P.next,o+=4;s+=T}for(i=0;i<T;i+=1){for(w=I=D=p=g=f=c=l=0,d=j*(C=A[o=i<<2]),v=j*(b=A[o+1]),m=j*(B=A[o+2]),F=j*(S=A[o+3]),l+=q*C,g+=q*b,f+=q*B,c+=q*S,U=L,n=0;n<j;n+=1)U.r=C,U.g=b,U.b=B,U.a=S,U=U.next;for(n=1,u=T;n<=e;n+=1)o=u+i<<2,l+=(U.r=C=A[o])*(R=j-n),g+=(U.g=b=A[o+1])*R,f+=(U.b=B=A[o+2])*R,c+=(U.a=S=A[o+3])*R,p+=C,w+=b,I+=B,D+=S,U=U.next,n<O&&(u+=T);for(r=0,o=i,G=L,P=k;r<z;r+=1)A[h=o<<2]=l*J>>K,A[h+1]=g*J>>K,A[h+2]=f*J>>K,A[h+3]=c*J>>K,l-=d,g-=v,f-=m,c-=F,d-=G.r,v-=G.g,m-=G.b,F-=G.a,h=i+((h=r+j)<O?h:O)*T<<2,l+=p+=G.r=A[h],g+=w+=G.g=A[h+1],f+=I+=G.b=A[h+2],c+=D+=G.a=A[h+3],G=G.next,d+=C=P.r,v+=b=P.g,m+=B=P.b,F+=S=P.a,p-=C,w-=b,I-=B,D-=S,P=P.next,o+=T}return E}}(),ImageFilters.Brightness=function(t,_){var $=t.data,a=t.width,e=t.height,i=($.length,this.utils.createImageData(a,e)),r=i.data;return this.utils.mapRGB($,r,function(t){return(t+=_)>255?255:t}),i},ImageFilters.BrightnessContrastGimp=function(t,_,$){var a=t.data,e=t.width,i=t.height,r=a.length,n=this.utils.createImageData(e,i),h=n.data;_/=100,$*=.99,$/=100,$=Math.tan(($+1)*(Math.PI/4));for(var u=0,o=0;o<r;o+=4)u+=19595*a[o]+38470*a[o+1]+7471*a[o+2]>>16;return u/=r/4,this.utils.mapRGB(a,h,function(t){return _<0?t*=1+_:_>0&&(t+=(255-t)*_),0!==$&&(t=(t-u)*$+u),t+.5|0}),n},ImageFilters.BrightnessContrastPhotoshop=function(t,_,$){var a=t.data,e=t.width,i=t.height,r=(a.length,this.utils.createImageData(e,i)),n=r.data;return _=(_+100)/100,$=($+100)/100,this.utils.mapRGB(a,n,function(t){return t*=_,(t=(t-127.5)*$+127.5)+.5|0}),r},ImageFilters.Channels=function(t,_){var $;switch(_){case 2:$=[0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,1,0];break;case 3:$=[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,1,0];break;default:$=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,1,0]}return this.ColorMatrixFilter(t,$)},ImageFilters.Clone=function(t){return this.Copy(t,this.utils.createImageData(t.width,t.height))},ImageFilters.CloneBuiltin=function(t){var _,$=t.width,a=t.height,e=this.utils.getSampleCanvas(),i=this.utils.getSampleContext();return e.width=$,e.height=a,i.putImageData(t,0,0),_=i.getImageData(0,0,$,a),e.width=0,e.height=0,_},ImageFilters.ColorMatrixFilter=function(t,_){var $,a,e,i,r,n,h=t.data,u=t.width,o=t.height,s=h.length,l=this.utils.createImageData(u,o),g=l.data,f=_[0],c=_[1],d=_[2],v=_[3],m=_[4],F=_[5],p=_[6],w=_[7],I=_[8],D=_[9],C=_[10],b=_[11],B=_[12],S=_[13],R=_[14],G=_[15],P=_[16],k=_[17],M=_[18],T=_[19];for(a=0;a<s;a+=4)e=h[a],i=h[a+1],r=h[a+2],n=h[a+3],g[a]=($=e*f+i*c+r*d+n*v+m)>255?255:$<0?0:0|$,g[a+1]=($=e*F+i*p+r*w+n*I+D)>255?255:$<0?0:0|$,g[a+2]=($=e*C+i*b+r*B+n*S+R)>255?255:$<0?0:0|$,g[a+3]=($=e*G+i*P+r*k+n*M+T)>255?255:$<0?0:0|$;return l},ImageFilters.ColorTransformFilter=function(t,_,$,a,e,i,r,n,h){var u,o,s=t.data,l=t.width,g=t.height,f=s.length,c=this.utils.createImageData(l,g),d=c.data;for(u=0;u<f;u+=4)d[u]=(o=s[u]*_+i)>255?255:o<0?0:o,d[u+1]=(o=s[u+1]*$+r)>255?255:o<0?0:o,d[u+2]=(o=s[u+2]*a+n)>255?255:o<0?0:o,d[u+3]=(o=s[u+3]*e+h)>255?255:o<0?0:o;return c},ImageFilters.Copy=function(t,_){for(var $=t.data,a=$.length,e=_.data;a--;)e[a]=$[a];return _},ImageFilters.Crop=function(t,_,$,a,e){var i,r,n,h,u=t.data,o=t.width,s=t.height,l=(u.length,this.utils.createImageData(a,e)),g=l.data,f=Math.max(_,0),c=Math.max($,0),d=Math.min(_+a,o),v=Math.min($+e,s),m=f-_;for(i=c,dstRow=c-$;i<v;i+=1,dstRow+=1)for(r=f,dstCol=m;r<d;r+=1,dstCol+=1)n=i*o+r<<2,g[h=dstRow*a+dstCol<<2]=u[n],g[h+1]=u[n+1],g[h+2]=u[n+2],g[h+3]=u[n+3];return l},ImageFilters.CropBuiltin=function(t,_,$,a,e){var i=t.width,r=t.height,n=this.utils.getSampleCanvas(),h=this.utils.getSampleContext();n.width=i,n.height=r,h.putImageData(t,0,0);var u=h.getImageData(_,$,a,e);return n.width=0,n.height=0,u},ImageFilters.Desaturate=function(t){for(var _=t.data,$=t.width,a=t.height,e=_.length,i=this.utils.createImageData($,a),r=i.data,n=0;n<e;n+=4){var h=_[n],u=_[n+1],o=_[n+2],s=h>u?h>o?h:o:u>o?u:o,l=h<u?h<o?h:o:u<o?u:o,g=(s+l)/2+.5|0;r[n]=r[n+1]=r[n+2]=g,r[n+3]=_[n+3]}return i},ImageFilters.DisplacementMapFilter=function(t,_,$,a,e,i,r,n,h){var u=t.data,o=t.width,s=t.height,l=(u.length,ImageFilters.Clone(t)),g=l.data;$||($=0),a||(a=0),e||(e=0),i||(i=0),r||(r=0),n||(n=0),h||(h=2);var f,c,d,v,m,F,p,w,I,D=_.width,C=_.height,b=_.data,B=D+$,S=C+a;for(w=0;w<o;w+=1)for(I=0;I<s;I+=1)f=I*o+w<<2,w<$||I<a||w>=B||I>=S?c=f:(v=b[(d=(I-a)*D+(w-$)<<2)+e],F=w+((v-128)*r>>8),p=I+(((m=b[d+i])-128)*n>>8),null===(c=ImageFilters.utils.getPixelIndex(F+.5|0,p+.5|0,o,s,h))&&(c=f)),g[f]=u[c],g[f+1]=u[c+1],g[f+2]=u[c+2],g[f+3]=u[c+3];return l},ImageFilters.Dither=function(t,_){var $,a,e=t.width,i=t.height,r=this.Clone(t),n=r.data,h=[],u=(_=_<2?2:_>255?255:_)-1,o=0,s=0;for(a=0;a<_;a+=1)h[a]=255*a/u;$=this.utils.buildMap(function(t){var $=h[o];return(s+=_)>255&&(s-=255,o+=1),$});var l,g,f,c,d,v,m,F,p,w,I,D,C,b,B,S=e-1,R=i-1,G=7/16,P=3/16,k=5/16,M=1/16;for(g=0;g<i;g+=1)for(l=0;l<e;l+=1)c=n[f=g*e+l<<2],d=n[f+1],v=n[f+2],m=$[c],F=$[d],p=$[v],n[f]=m,n[f+1]=F,n[f+2]=p,w=c-m,I=d-F,D=v-p,f+=4,l<S&&(C=n[f]+G*w,b=n[f+1]+G*I,B=n[f+2]+G*D,n[f]=C>255?255:C<0?0:0|C,n[f+1]=b>255?255:b<0?0:0|b,n[f+2]=B>255?255:B<0?0:0|B),f+=e-2<<2,l>0&&g<R&&(C=n[f]+P*w,b=n[f+1]+P*I,B=n[f+2]+P*D,n[f]=C>255?255:C<0?0:0|C,n[f+1]=b>255?255:b<0?0:0|b,n[f+2]=B>255?255:B<0?0:0|B),f+=4,g<R&&(C=n[f]+k*w,b=n[f+1]+k*I,B=n[f+2]+k*D,n[f]=C>255?255:C<0?0:0|C,n[f+1]=b>255?255:b<0?0:0|b,n[f+2]=B>255?255:B<0?0:0|B),f+=4,l<S&&g<R&&(C=n[f]+M*w,b=n[f+1]+M*I,B=n[f+2]+M*D,n[f]=C>255?255:C<0?0:0|C,n[f+1]=b>255?255:b<0?0:0|b,n[f+2]=B>255?255:B<0?0:0|B);return r},ImageFilters.Edge=function(t){return this.ConvolutionFilter(t,3,3,[-1,-1,-1,-1,8,-1,-1,-1,-1])},ImageFilters.Emboss=function(t){return this.ConvolutionFilter(t,3,3,[-2,-1,0,-1,1,1,0,1,2])},ImageFilters.Enrich=function(t){return this.ConvolutionFilter(t,3,3,[0,-2,0,-2,20,-2,0,-2,0],10,-40)},ImageFilters.Flip=function(t,_){var $,a,e,i,r=t.data,n=t.width,h=t.height,u=(r.length,this.utils.createImageData(n,h)),o=u.data;for(a=0;a<h;a+=1)for($=0;$<n;$+=1)e=a*n+$<<2,o[i=_?(h-a-1)*n+$<<2:a*n+(n-$-1)<<2]=r[e],o[i+1]=r[e+1],o[i+2]=r[e+2],o[i+3]=r[e+3];return u},ImageFilters.Gamma=function(t,_){var $=t.data,a=t.width,e=t.height,i=($.length,this.utils.createImageData(a,e)),r=i.data;return this.utils.mapRGB($,r,function(t){return(t=255*Math.pow(t/255,1/_)+.5)>255?255:t+.5|0}),i},ImageFilters.GrayScale=function(t){for(var _=t.data,$=t.width,a=t.height,e=_.length,i=this.utils.createImageData($,a),r=i.data,n=0;n<e;n+=4){var h=19595*_[n]+38470*_[n+1]+7471*_[n+2]>>16;r[n]=r[n+1]=r[n+2]=h,r[n+3]=_[n+3]}return i},ImageFilters.HSLAdjustment=function(t,_,$,a){var e,i,r,n,h,u,o=t.data,s=t.width,l=t.height,g=o.length,f=this.utils.createImageData(s,l),c=f.data;_/=360,$/=100,a/=100;var d=this.utils.rgbToHsl,v=this.utils.hslToRgb;for(u=0;u<g;u+=4){for(e=(n=d(o[u],o[u+1],o[u+2]))[0]+_;e<0;)e+=1;for(;e>1;)e-=1;(i=n[1]+n[1]*$)<0?i=0:i>1&&(i=1),r=n[2],a>0?r+=(1-r)*a:a<0&&(r+=r*a),h=v(e,i,r),c[u]=h[0],c[u+1]=h[1],c[u+2]=h[2],c[u+3]=o[u+3]}return f},ImageFilters.Invert=function(t){var _=t.data,$=t.width,a=t.height,e=(_.length,this.utils.createImageData($,a)),i=e.data;return this.utils.mapRGB(_,i,function(t){return 255-t}),e},ImageFilters.Mosaic=function(t,_){var $,a,e,i,r,n,h,u,o,s,l,g,f,c,d,v=t.data,m=t.width,F=t.height,p=(v.length,this.utils.createImageData(m,F)),w=p.data,I=Math.ceil(m/_),D=Math.ceil(F/_);for($=0;$<D;$+=1)for((n=(r=$*_)+_)>F&&(n=F),a=0;a<I;a+=1){for((i=(e=a*_)+_)>m&&(i=m),g=f=c=d=0,l=(i-e)*(n-r),u=r;u<n;u+=1)for(o=u*m,h=e;h<i;h+=1)g+=v[s=o+h<<2],f+=v[s+1],c+=v[s+2],d+=v[s+3];for(g=g/l+.5|0,f=f/l+.5|0,c=c/l+.5|0,d=d/l+.5|0,u=r;u<n;u+=1)for(o=u*m,h=e;h<i;h+=1)w[s=o+h<<2]=g,w[s+1]=f,w[s+2]=c,w[s+3]=d}return p},ImageFilters.Oil=function(t,_,$){var a,e,i,r,n,h,u,o,s,l,g,f,c,d,v,m,F,p,w=t.data,I=t.width,D=t.height,C=(w.length,this.utils.createImageData(I,D)),b=C.data,B=0,S=[],R=[],G=[],P=[],k=[],M=[];for(e=0;e<D;e+=1)for(a=0;a<I;a+=1){for(i=0;i<$;i+=1)S[i]=R[i]=G[i]=P[i]=k[i]=M[i]=0;for(r=-_;r<=_;r+=1)if(!((h=e+r)<0)&&!(h>=D))for(o=h*I,n=-_;n<=_;n+=1)!((u=a+n)<0)&&!(u>=I)&&(l=w[s=o+u<<2],g=w[s+1],f=w[s+2],c=l*$>>8,d=g*$>>8,v=f*$>>8,P[c]+=l,k[d]+=g,M[v]+=f,S[c]+=1,R[d]+=1,G[v]+=1);for(i=1,m=F=p=0;i<$;i+=1)S[i]>S[m]&&(m=i),R[i]>R[F]&&(F=i),G[i]>G[p]&&(p=i);b[B]=P[m]/S[m]|0,b[B+1]=k[F]/R[F]|0,b[B+2]=M[p]/G[p]|0,b[B+3]=w[B+3],B+=4}return C},ImageFilters.OpacityFilter=function(t,_){for(var $=t.data,a=t.width,e=t.height,i=$.length,r=this.utils.createImageData(a,e),n=r.data,h=0;h<i;h+=4)n[h]=$[h],n[h+1]=$[h+1],n[h+2]=$[h+2],n[h+3]=_;return r},ImageFilters.Posterize=function(t,_){var $,a=t.data,e=t.width,i=t.height,r=(a.length,this.utils.createImageData(e,i)),n=r.data,h=[],u=(_=_<2?2:_>255?255:_)-1,o=0,s=0;for($=0;$<_;$+=1)h[$]=255*$/u;return this.utils.mapRGB(a,n,function(t){var $=h[o];return(s+=_)>255&&(s-=255,o+=1),$}),r},ImageFilters.Rescale=function(t,_){var $=t.data,a=t.width,e=t.height,i=($.length,this.utils.createImageData(a,e)),r=i.data;return this.utils.mapRGB($,r,function(t){return(t*=_)>255?255:t+.5|0}),i},ImageFilters.ResizeNearestNeighbor=function(t,_,$){var a,e,i,r,n=t.data,h=t.width,u=t.height,o=(n.length,this.utils.createImageData(_,$)),s=o.data,l=h/_,g=u/$,f=0;for(i=0;i<$;i+=1)for(e=0,r=(i*g|0)*h;e<_;e+=1)a=r+e*l<<2,s[f]=n[a],s[f+1]=n[a+1],s[f+2]=n[a+2],s[f+3]=n[a+3],f+=4;return o},ImageFilters.Resize=function(t,_,$){var a,e,i=t.data,r=t.width,n=t.height,h=(i.length,this.utils.createImageData(_,$)),u=h.data,o=r/_,s=n/$,l=0;for(e=0;e<$;e+=1)for(a=0;a<_;a+=1)this.utils.copyBilinear(i,a*o,e*s,r,n,u,l,0),l+=4;return h},ImageFilters.ResizeBuiltin=function(t,_,$){var a,e=t.width,i=t.height,r=this.utils.getSampleCanvas(),n=this.utils.getSampleContext();return r.width=Math.max(e,_),r.height=Math.max(i,$),n.save(),n.putImageData(t,0,0),n.scale(_/e,$/i),n.drawImage(r,0,0),a=n.getImageData(0,0,_,$),n.restore(),r.width=0,r.height=0,a},ImageFilters.Sepia=function(t){var _,$,a,e,i,r=t.data,n=t.width,h=t.height,u=r.length,o=this.utils.createImageData(n,h),s=o.data;for(e=0;e<u;e+=4)_=r[e],$=r[e+1],a=r[e+2],s[e]=(i=.393*_+.769*$+.189*a)>255?255:i<0?0:i+.5|0,s[e+1]=(i=.349*_+.686*$+.168*a)>255?255:i<0?0:i+.5|0,s[e+2]=(i=.272*_+.534*$+.131*a)>255?255:i<0?0:i+.5|0,s[e+3]=r[e+3];return o},ImageFilters.Sharpen=function(t,_){return this.ConvolutionFilter(t,3,3,[-_/16,-_/8,-_/16,-_/8,.75*_+1,-_/8,-_/16,-_/8,-_/16])},ImageFilters.Solarize=function(t){var _=t.data,$=t.width,a=t.height,e=(_.length,this.utils.createImageData($,a)),i=e.data;return this.utils.mapRGB(_,i,function(t){return t>127?(t-127.5)*2:(127.5-t)*2}),e},ImageFilters.Transpose=function(t){var _,$,a=t.data,e=t.width,i=t.height,r=(a.length,this.utils.createImageData(i,e)),n=r.data;for(y=0;y<i;y+=1)for(x=0;x<e;x+=1)_=y*e+x<<2,n[$=x*i+y<<2]=a[_],n[$+1]=a[_+1],n[$+2]=a[_+2],n[$+3]=a[_+3];return r},ImageFilters.Twril=function(t,_,$,a,e,i,r){var n=t.data,h=t.width,u=t.height,o=(n.length,this.utils.createImageData(h,u)),s=o.data;_*=h,$*=u,e*=Math.PI/180;var l,g,f,c,d,v,m,F,p,w=a*a,I=0;for(g=0;g<u;g+=1)for(l=0;l<h;l+=1)(d=(f=l-_)*f+(c=g-$)*c)>w?(s[I]=n[I],s[I+1]=n[I+1],s[I+2]=n[I+2],s[I+3]=n[I+3]):(v=Math.atan2(c,f)+e*(a-(d=Math.sqrt(d)))/a,m=_+d*Math.cos(v),F=$+d*Math.sin(v),r?this.utils.copyBilinear(n,m,F,h,u,s,I,i):(p=(F+.5|0)*h+(m+.5|0)<<2,s[I]=n[p],s[I+1]=n[p+1],s[I+2]=n[p+2],s[I+3]=n[p+3])),I+=4;return o};