var ImageFilters={};ImageFilters.utils={initSampleCanvas:function(){var t=document.createElement("canvas"),a=t.getContext("2d");t.width=0,t.height=0,this.getSampleCanvas=function(){return t},this.getSampleContext=function(){return a},this.createImageData=a.createImageData?function(t,_){return a.createImageData(t,_)}:function(t,a){return new ImageData(t,a)}},getSampleCanvas:function(){return this.initSampleCanvas(),this.getSampleCanvas()},getSampleContext:function(){return this.initSampleCanvas(),this.getSampleContext()},createImageData:function(t,a){return this.initSampleCanvas(),this.createImageData(t,a)},clamp:function(t){return t>255?255:t<0?0:t},buildMap:function(t){for(var a,_=[],e=0;e<256;e+=1)_[e]=(a=t(e))>255?255:a<0?0:0|a;return _},applyMap:function(t,a,_){for(var e=0,$=t.length;e<$;e+=4)a[e]=_[t[e]],a[e+1]=_[t[e+1]],a[e+2]=_[t[e+2]],a[e+3]=t[e+3]},mapRGB:function(t,a,_){this.applyMap(t,a,this.buildMap(_))},getPixelIndex:function(t,a,_,e,$){if(t<0||t>=_||a<0||a>=e)switch($){case 1:t=t<0?0:t>=_?_-1:t,a=a<0?0:a>=e?e-1:a;break;case 2:t=(t%=_)<0?t+_:t,a=(a%=e)<0?a+e:a;break;default:return null}return a*_+t<<2},getPixel:function(t,a,_,e,$,r){if(a<0||a>=e||_<0||_>=$)switch(r){case 1:a=a<0?0:a>=e?e-1:a,_=_<0?0:_>=$?$-1:_;break;case 2:a=(a%=e)<0?a+e:a,_=(_%=$)<0?_+$:_;break;default:return 0}var i=_*e+a<<2;return t[i+3]<<24|t[i]<<16|t[i+1]<<8|t[i+2]},getPixelByIndex:function(t,a){return t[a+3]<<24|t[a]<<16|t[a+1]<<8|t[a+2]},copyBilinear:function(t,a,_,e,$,r,i,n){var h,s,l,u,g,o,f,c=a<0?a-1|0:0|a,m=_<0?_-1|0:0|_,d=a-c,F=_-m,I=0,v=0,p=0,w=0;if(c>=0&&c<e-1&&m>=0&&m<$-1){if(h=m*e+c<<2,d||F)I=t[h+3]<<24|t[h]<<16|t[h+1]<<8|t[h+2],h+=4,v=t[h+3]<<24|t[h]<<16|t[h+1]<<8|t[h+2],p=t[(h=h-8+(e<<2))+3]<<24|t[h]<<16|t[h+1]<<8|t[h+2],h+=4,w=t[h+3]<<24|t[h]<<16|t[h+1]<<8|t[h+2];else{r[i]=t[h],r[i+1]=t[h+1],r[i+2]=t[h+2],r[i+3]=t[h+3];return}}else if(I=this.getPixel(t,c,m,e,$,n),d||F)v=this.getPixel(t,c+1,m,e,$,n),p=this.getPixel(t,c,m+1,e,$,n),w=this.getPixel(t,c+1,m+1,e,$,n);else{r[i]=I>>16&255,r[i+1]=I>>8&255,r[i+2]=255&I,r[i+3]=I>>24&255;return}u=((I>>16&255)*(s=1-d)+(v>>16&255)*d)*(l=1-F)+((p>>16&255)*s+(w>>16&255)*d)*F,g=((I>>8&255)*s+(v>>8&255)*d)*l+((p>>8&255)*s+(w>>8&255)*d)*F,o=((255&I)*s+(255&v)*d)*l+((255&p)*s+(255&w)*d)*F,f=((I>>24&255)*s+(v>>24&255)*d)*l+((p>>24&255)*s+(w>>24&255)*d)*F,r[i]=u>255?255:u<0?0:0|u,r[i+1]=g>255?255:g<0?0:0|g,r[i+2]=o>255?255:o<0?0:0|o,r[i+3]=f>255?255:f<0?0:0|f},rgbToHsl:function(t,a,_){_/=255;var e=(t/=255)>(a/=255)?t>_?t:_:a>_?a:_,$=t<a?t<_?t:_:a<_?a:_,r=e-$,i=0,n=0,h=($+e)/2;return 0!==r&&(i=t===e?(a-_)/r+(a<_?6:0):a===e?(_-t)/r+2:(t-a)/r+4,i/=6,n=h>.5?r/(2-e-$):r/(e+$)),[i,n,h]},hslToRgb:function(t,a,_){var e,$,r,i,n,h,s=[];if(0===a)s=[i=n=h=255*_+.5|0,n,h];else{$=_<=.5?_*(a+1):_+a-_*a,e=2*_-$,r=t+1/3;for(var l,u=0;u<3;u+=1)r<0?r+=1:r>1&&(r-=1),l=6*r<1?e+($-e)*r*6:2*r<1?$:3*r<2?e+($-e)*(2/3-r)*6:e,s[u]=255*l+.5|0,r-=1/3}return s}},ImageFilters.Translate=function(t,a,_,e){},ImageFilters.Scale=function(t,a,_,e){},ImageFilters.Rotate=function(t,a,_,e,$,r){},ImageFilters.Affine=function(t,a,_,e){},ImageFilters.UnsharpMask=function(t,a){},ImageFilters.ConvolutionFilter=function(t,a,_,e,$,r,i,n,h,s){var l=t.data,u=t.width,g=t.height,o=(l.length,this.utils.createImageData(u,g)),f=o.data;$=$||1,r=r||0,!1!==i&&(i=!0),!1!==n&&(n=!0);for(var c=0,m=a>>1,d=_>>1,F=(h=h||0)>>16&255,I=h>>8&255,v=255&h,p=255*(s=s||0),w=0;w<g;w+=1)for(var D=0;D<u;D+=1,c+=4){for(var C,b=0,B=0,S=0,R=0,G=!1,P=0,k=-m;k<=m;k+=1){var M,T=w+k;0<=T&&T<g?M=T*u:n?M=w*u:G=!0;for(var z=-d;z<=d;z+=1){var E=e[P++];if(0!==E){var A=D+z;if(0<=A&&A<u||(n?A=D:G=!0),G)b+=E*F,B+=E*I,S+=E*v,R+=E*p;else{var H=M+A<<2;b+=E*l[H],B+=E*l[H+1],S+=E*l[H+2],R+=E*l[H+3]}}}}f[c]=(C=b/$+r)>255?255:C<0?0:0|C,f[c+1]=(C=B/$+r)>255?255:C<0?0:0|C,f[c+2]=(C=S/$+r)>255?255:C<0?0:0|C,f[c+3]=i?l[c+3]:(C=R/$+r)>255?255:C<0?0:0|C}return o},ImageFilters.Binarize=function(t,a){var _=t.data,e=t.width,$=t.height,r=_.length,i=this.utils.createImageData(e,$),n=i.data;isNaN(a)&&(a=.5),a*=255;for(var h=0;h<r;h+=4){var s=_[h]+_[h+1]+_[h+2]/3;n[h]=n[h+1]=n[h+2]=s<=a?0:255,n[h+3]=255}return i},ImageFilters.BlendAdd=function(t,a,_,e){for(var $,r=t.data,i=t.width,n=t.height,h=r.length,s=this.utils.createImageData(i,n),l=s.data,u=a.data,g=0;g<h;g+=4)l[g]=($=r[g]+u[g])>255?255:$,l[g+1]=($=r[g+1]+u[g+1])>255?255:$,l[g+2]=($=r[g+2]+u[g+2])>255?255:$,l[g+3]=255;return s},ImageFilters.BlendSubtract=function(t,a,_,e){for(var $,r=t.data,i=t.width,n=t.height,h=r.length,s=this.utils.createImageData(i,n),l=s.data,u=a.data,g=0;g<h;g+=4)l[g]=($=r[g]-u[g])<0?0:$,l[g+1]=($=r[g+1]-u[g+1])<0?0:$,l[g+2]=($=r[g+2]-u[g+2])<0?0:$,l[g+3]=255;return s},ImageFilters.BoxBlur=function(){var t=function(t,a,_,e,$){var r,i,n,h,s,l,u,g,o,f,c,m,d,F,I=2*$+1,v=$+1,p=_-1,w=0,D=[];for(o=0,f=256*I;o<f;o+=1)D[o]=o/I|0;for(m=0;m<e;m+=1){for(r=i=n=h=0,s=m,r+=v*t[l=w<<2],i+=v*t[l+1],n+=v*t[l+2],h+=v*t[l+3],o=1;o<=$;o+=1)r+=t[l=w+(o<_?o:p)<<2],i+=t[l+1],n+=t[l+2],h+=t[l+3];for(c=0;c<_;c+=1)a[l=s<<2]=D[r],a[l+1]=D[i],a[l+2]=D[n],a[l+3]=D[h],(d=c+v)>p&&(d=p),(F=c-$)<0&&(F=0),u=w+d<<2,g=w+F<<2,r+=t[u]-t[g],i+=t[u+1]-t[g+1],n+=t[u+2]-t[g+2],h+=t[u+3]-t[g+3],s+=e;w+=_}};return function(a,_,e,$){for(var r=a.data,i=a.width,n=a.height,h=(r.length,this.utils.createImageData(i,n)),s=h.data,l=this.utils.createImageData(i,n).data,u=0;u<$;u+=1)t(u?s:r,l,i,n,_),t(l,s,n,i,e);return h}}(),ImageFilters.GaussianBlur=function(t,a){var _,e,$;switch(a){case 2:_=5,e=[1,1,2,1,1,1,2,4,2,1,2,4,8,4,2,1,2,4,2,1,1,1,2,1,1],$=52;break;case 3:_=7,e=[1,1,2,2,2,1,1,1,2,2,4,2,2,1,2,2,4,8,4,2,2,2,4,8,16,8,4,2,2,2,4,8,4,2,2,1,2,2,4,2,2,1,1,1,2,2,2,1,1],$=140;break;case 4:_=15,e=[2,2,3,4,5,5,6,6,6,5,5,4,3,2,2,2,3,4,5,7,7,8,8,8,7,7,5,4,3,2,3,4,6,7,9,10,10,11,10,10,9,7,6,4,3,4,5,7,9,10,12,13,13,13,12,10,9,7,5,4,5,7,9,11,13,14,15,16,15,14,13,11,9,7,5,5,7,10,12,14,16,17,18,17,16,14,12,10,7,5,6,8,10,13,15,17,19,19,19,17,15,13,10,8,6,6,8,11,13,16,18,19,20,19,18,16,13,11,8,6,6,8,10,13,15,17,19,19,19,17,15,13,10,8,6,5,7,10,12,14,16,17,18,17,16,14,12,10,7,5,5,7,9,11,13,14,15,16,15,14,13,11,9,7,5,4,5,7,9,10,12,13,13,13,12,10,9,7,5,4,3,4,6,7,9,10,10,11,10,10,9,7,6,4,3,2,3,4,5,7,7,8,8,8,7,7,5,4,3,2,2,2,3,4,5,5,6,6,6,5,5,4,3,2,2],$=2044;break;default:_=3,e=[1,2,1,2,4,2,1,2,1],$=16}return this.ConvolutionFilter(t,_,_,e,$,0,!1)},ImageFilters.StackBlur=function(){var t=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],a=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function _(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}return function(e,$){var r,i,n,h,s,l,u,g,o,f,c,m,d,F,I,v,p,w,D,C,b,B,S,R,G,P,k,M=e.data,T=e.width,z=e.height,E=(M.length,this.Clone(e)),A=E.data,H=$+$+1,N=T-1,O=z-1,j=$+1,q=j*(j+1)/2,L=new _,U=L,J=t[$],K=a[$];for(n=1;n<H;n+=1)U=U.next=new _,n==j&&(k=U);for(i=0,U.next=L,u=l=0;i<z;i+=1){for(v=p=w=D=g=o=f=c=0,m=j*(C=A[l]),d=j*(b=A[l+1]),F=j*(B=A[l+2]),I=j*(S=A[l+3]),g+=q*C,o+=q*b,f+=q*B,c+=q*S,U=L,n=0;n<j;n+=1)U.r=C,U.g=b,U.b=B,U.a=S,U=U.next;for(n=1;n<j;n+=1)h=l+((N<n?N:n)<<2),g+=(U.r=C=A[h])*(R=j-n),o+=(U.g=b=A[h+1])*R,f+=(U.b=B=A[h+2])*R,c+=(U.a=S=A[h+3])*R,v+=C,p+=b,w+=B,D+=S,U=U.next;for(r=0,G=L,P=k;r<T;r+=1)A[l]=g*J>>K,A[l+1]=o*J>>K,A[l+2]=f*J>>K,A[l+3]=c*J>>K,g-=m,o-=d,f-=F,c-=I,m-=G.r,d-=G.g,F-=G.b,I-=G.a,h=u+((h=r+$+1)<N?h:N)<<2,v+=G.r=A[h],p+=G.g=A[h+1],w+=G.b=A[h+2],D+=G.a=A[h+3],g+=v,o+=p,f+=w,c+=D,G=G.next,m+=C=P.r,d+=b=P.g,F+=B=P.b,I+=S=P.a,v-=C,p-=b,w-=B,D-=S,P=P.next,l+=4;u+=T}for(r=0;r<T;r+=1){for(p=w=D=v=o=f=c=g=0,m=j*(C=A[l=r<<2]),d=j*(b=A[l+1]),F=j*(B=A[l+2]),I=j*(S=A[l+3]),g+=q*C,o+=q*b,f+=q*B,c+=q*S,U=L,n=0;n<j;n+=1)U.r=C,U.g=b,U.b=B,U.a=S,U=U.next;for(n=1,s=T;n<=$;n+=1)l=s+r<<2,g+=(U.r=C=A[l])*(R=j-n),o+=(U.g=b=A[l+1])*R,f+=(U.b=B=A[l+2])*R,c+=(U.a=S=A[l+3])*R,v+=C,p+=b,w+=B,D+=S,U=U.next,n<O&&(s+=T);for(i=0,l=r,G=L,P=k;i<z;i+=1)A[h=l<<2]=g*J>>K,A[h+1]=o*J>>K,A[h+2]=f*J>>K,A[h+3]=c*J>>K,g-=m,o-=d,f-=F,c-=I,m-=G.r,d-=G.g,F-=G.b,I-=G.a,h=r+((h=i+j)<O?h:O)*T<<2,g+=v+=G.r=A[h],o+=p+=G.g=A[h+1],f+=w+=G.b=A[h+2],c+=D+=G.a=A[h+3],G=G.next,m+=C=P.r,d+=b=P.g,F+=B=P.b,I+=S=P.a,v-=C,p-=b,w-=B,D-=S,P=P.next,l+=T}return E}}(),ImageFilters.Brightness=function(t,a){var _=t.data,e=t.width,$=t.height,r=(_.length,this.utils.createImageData(e,$)),i=r.data;return this.utils.mapRGB(_,i,function(t){return(t+=a)>255?255:t}),r},ImageFilters.BrightnessContrastGimp=function(t,a,_){var e=t.data,$=t.width,r=t.height,i=e.length,n=this.utils.createImageData($,r),h=n.data;a/=100,_*=.99,_/=100,_=Math.tan((_+1)*(Math.PI/4));for(var s=0,l=0;l<i;l+=4)s+=19595*e[l]+38470*e[l+1]+7471*e[l+2]>>16;return s/=i/4,this.utils.mapRGB(e,h,function(t){return a<0?t*=1+a:a>0&&(t+=(255-t)*a),0!==_&&(t=(t-s)*_+s),t+.5|0}),n},ImageFilters.BrightnessContrastPhotoshop=function(t,a,_){var e=t.data,$=t.width,r=t.height,i=(e.length,this.utils.createImageData($,r)),n=i.data;return a=(a+100)/100,_=(_+100)/100,this.utils.mapRGB(e,n,function(t){return t*=a,(t=(t-127.5)*_+127.5)+.5|0}),i},ImageFilters.Channels=function(t,a){var _;switch(a){case 2:_=[0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,1,0];break;case 3:_=[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,1,0];break;default:_=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,1,0]}return this.ColorMatrixFilter(t,_)},ImageFilters.Clone=function(t){return this.Copy(t,this.utils.createImageData(t.width,t.height))},ImageFilters.CloneBuiltin=function(t){var a,_=t.width,e=t.height,$=this.utils.getSampleCanvas(),r=this.utils.getSampleContext();return $.width=_,$.height=e,r.putImageData(t,0,0),a=r.getImageData(0,0,_,e),$.width=0,$.height=0,a},ImageFilters.ColorMatrixFilter=function(t,a){var _,e,$,r,i,n,h=t.data,s=t.width,l=t.height,u=h.length,g=this.utils.createImageData(s,l),o=g.data,f=a[0],c=a[1],m=a[2],d=a[3],F=a[4],I=a[5],v=a[6],p=a[7],w=a[8],D=a[9],C=a[10],b=a[11],B=a[12],S=a[13],R=a[14],G=a[15],P=a[16],k=a[17],M=a[18],T=a[19];for(e=0;e<u;e+=4)$=h[e],r=h[e+1],i=h[e+2],n=h[e+3],o[e]=(_=$*f+r*c+i*m+n*d+F)>255?255:_<0?0:0|_,o[e+1]=(_=$*I+r*v+i*p+n*w+D)>255?255:_<0?0:0|_,o[e+2]=(_=$*C+r*b+i*B+n*S+R)>255?255:_<0?0:0|_,o[e+3]=(_=$*G+r*P+i*k+n*M+T)>255?255:_<0?0:0|_;return g},ImageFilters.ColorTransformFilter=function(t,a,_,e,$,r,i,n,h){var s,l,u=t.data,g=t.width,o=t.height,f=u.length,c=this.utils.createImageData(g,o),m=c.data;for(s=0;s<f;s+=4)m[s]=(l=u[s]*a+r)>255?255:l<0?0:l,m[s+1]=(l=u[s+1]*_+i)>255?255:l<0?0:l,m[s+2]=(l=u[s+2]*e+n)>255?255:l<0?0:l,m[s+3]=(l=u[s+3]*$+h)>255?255:l<0?0:l;return c},ImageFilters.Copy=function(t,a){for(var _=t.data,e=_.length,$=a.data;e--;)$[e]=_[e];return a},ImageFilters.Crop=function(t,a,_,e,$){var r,i,n,h,s=t.data,l=t.width,u=t.height,g=(s.length,this.utils.createImageData(e,$)),o=g.data,f=Math.max(a,0),c=Math.max(_,0),m=Math.min(a+e,l),d=Math.min(_+$,u),F=f-a;for(r=c,dstRow=c-_;r<d;r+=1,dstRow+=1)for(i=f,dstCol=F;i<m;i+=1,dstCol+=1)n=r*l+i<<2,o[h=dstRow*e+dstCol<<2]=s[n],o[h+1]=s[n+1],o[h+2]=s[n+2],o[h+3]=s[n+3];return g},ImageFilters.CropBuiltin=function(t,a,_,e,$){var r=t.width,i=t.height,n=this.utils.getSampleCanvas(),h=this.utils.getSampleContext();n.width=r,n.height=i,h.putImageData(t,0,0);var s=h.getImageData(a,_,e,$);return n.width=0,n.height=0,s},ImageFilters.Desaturate=function(t){for(var a=t.data,_=t.width,e=t.height,$=a.length,r=this.utils.createImageData(_,e),i=r.data,n=0;n<$;n+=4){var h=a[n],s=a[n+1],l=a[n+2],u=h>s?h>l?h:l:s>l?s:l,g=h<s?h<l?h:l:s<l?s:l,o=(u+g)/2+.5|0;i[n]=i[n+1]=i[n+2]=o,i[n+3]=a[n+3]}return r},ImageFilters.DisplacementMapFilter=function(t,a,_,e,$,r,i,n,h){var s=t.data,l=t.width,u=t.height,g=(s.length,ImageFilters.Clone(t)),o=g.data;_||(_=0),e||(e=0),$||($=0),r||(r=0),i||(i=0),n||(n=0),h||(h=2);var f,c,m,d,F,I,v,p,w,D=a.width,C=a.height,b=a.data,B=D+_,S=C+e;for(p=0;p<l;p+=1)for(w=0;w<u;w+=1)f=w*l+p<<2,p<_||w<e||p>=B||w>=S?c=f:(d=b[(m=(w-e)*D+(p-_)<<2)+$],I=p+((d-128)*i>>8),v=w+(((F=b[m+r])-128)*n>>8),null===(c=ImageFilters.utils.getPixelIndex(I+.5|0,v+.5|0,l,u,h))&&(c=f)),o[f]=s[c],o[f+1]=s[c+1],o[f+2]=s[c+2],o[f+3]=s[c+3];return g},ImageFilters.Dither=function(t,a){var _,e,$=t.width,r=t.height,i=this.Clone(t),n=i.data,h=[],s=(a=a<2?2:a>255?255:a)-1,l=0,u=0;for(e=0;e<a;e+=1)h[e]=255*e/s;_=this.utils.buildMap(function(t){var _=h[l];return(u+=a)>255&&(u-=255,l+=1),_});var g,o,f,c,m,d,F,I,v,p,w,D,C,b,B,S=$-1,R=r-1,G=7/16,P=3/16,k=5/16,M=1/16;for(o=0;o<r;o+=1)for(g=0;g<$;g+=1)c=n[f=o*$+g<<2],m=n[f+1],d=n[f+2],F=_[c],I=_[m],v=_[d],n[f]=F,n[f+1]=I,n[f+2]=v,p=c-F,w=m-I,D=d-v,f+=4,g<S&&(C=n[f]+G*p,b=n[f+1]+G*w,B=n[f+2]+G*D,n[f]=C>255?255:C<0?0:0|C,n[f+1]=b>255?255:b<0?0:0|b,n[f+2]=B>255?255:B<0?0:0|B),f+=$-2<<2,g>0&&o<R&&(C=n[f]+P*p,b=n[f+1]+P*w,B=n[f+2]+P*D,n[f]=C>255?255:C<0?0:0|C,n[f+1]=b>255?255:b<0?0:0|b,n[f+2]=B>255?255:B<0?0:0|B),f+=4,o<R&&(C=n[f]+k*p,b=n[f+1]+k*w,B=n[f+2]+k*D,n[f]=C>255?255:C<0?0:0|C,n[f+1]=b>255?255:b<0?0:0|b,n[f+2]=B>255?255:B<0?0:0|B),f+=4,g<S&&o<R&&(C=n[f]+M*p,b=n[f+1]+M*w,B=n[f+2]+M*D,n[f]=C>255?255:C<0?0:0|C,n[f+1]=b>255?255:b<0?0:0|b,n[f+2]=B>255?255:B<0?0:0|B);return i},ImageFilters.Edge=function(t){return this.ConvolutionFilter(t,3,3,[-1,-1,-1,-1,8,-1,-1,-1,-1])},ImageFilters.Emboss=function(t){return this.ConvolutionFilter(t,3,3,[-2,-1,0,-1,1,1,0,1,2])},ImageFilters.Enrich=function(t){return this.ConvolutionFilter(t,3,3,[0,-2,0,-2,20,-2,0,-2,0],10,-40)},ImageFilters.Flip=function(t,a){var _,e,$,r,i=t.data,n=t.width,h=t.height,s=(i.length,this.utils.createImageData(n,h)),l=s.data;for(e=0;e<h;e+=1)for(_=0;_<n;_+=1)$=e*n+_<<2,l[r=a?(h-e-1)*n+_<<2:e*n+(n-_-1)<<2]=i[$],l[r+1]=i[$+1],l[r+2]=i[$+2],l[r+3]=i[$+3];return s},ImageFilters.Gamma=function(t,a){var _=t.data,e=t.width,$=t.height,r=(_.length,this.utils.createImageData(e,$)),i=r.data;return this.utils.mapRGB(_,i,function(t){return(t=255*Math.pow(t/255,1/a)+.5)>255?255:t+.5|0}),r},ImageFilters.GrayScale=function(t){for(var a=t.data,_=t.width,e=t.height,$=a.length,r=this.utils.createImageData(_,e),i=r.data,n=0;n<$;n+=4){var h=19595*a[n]+38470*a[n+1]+7471*a[n+2]>>16;i[n]=i[n+1]=i[n+2]=h,i[n+3]=a[n+3]}return r},ImageFilters.HSLAdjustment=function(t,a,_,e){var $,r,i,n,h,s,l=t.data,u=t.width,g=t.height,o=l.length,f=this.utils.createImageData(u,g),c=f.data;a/=360,_/=100,e/=100;var m=this.utils.rgbToHsl,d=this.utils.hslToRgb;for(s=0;s<o;s+=4){for($=(n=m(l[s],l[s+1],l[s+2]))[0]+a;$<0;)$+=1;for(;$>1;)$-=1;(r=n[1]+n[1]*_)<0?r=0:r>1&&(r=1),i=n[2],e>0?i+=(1-i)*e:e<0&&(i+=i*e),h=d($,r,i),c[s]=h[0],c[s+1]=h[1],c[s+2]=h[2],c[s+3]=l[s+3]}return f},ImageFilters.Invert=function(t){var a=t.data,_=t.width,e=t.height,$=(a.length,this.utils.createImageData(_,e)),r=$.data;return this.utils.mapRGB(a,r,function(t){return 255-t}),$},ImageFilters.Mosaic=function(t,a){var _,e,$,r,i,n,h,s,l,u,g,o,f,c,m,d=t.data,F=t.width,I=t.height,v=(d.length,this.utils.createImageData(F,I)),p=v.data,w=Math.ceil(F/a),D=Math.ceil(I/a);for(_=0;_<D;_+=1)for((n=(i=_*a)+a)>I&&(n=I),e=0;e<w;e+=1){for((r=($=e*a)+a)>F&&(r=F),o=f=c=m=0,g=(r-$)*(n-i),s=i;s<n;s+=1)for(l=s*F,h=$;h<r;h+=1)o+=d[u=l+h<<2],f+=d[u+1],c+=d[u+2],m+=d[u+3];for(o=o/g+.5|0,f=f/g+.5|0,c=c/g+.5|0,m=m/g+.5|0,s=i;s<n;s+=1)for(l=s*F,h=$;h<r;h+=1)p[u=l+h<<2]=o,p[u+1]=f,p[u+2]=c,p[u+3]=m}return v},ImageFilters.Oil=function(t,a,_){var e,$,r,i,n,h,s,l,u,g,o,f,c,m,d,F,I,v,p=t.data,w=t.width,D=t.height,C=(p.length,this.utils.createImageData(w,D)),b=C.data,B=0,S=[],R=[],G=[],P=[],k=[],M=[];for($=0;$<D;$+=1)for(e=0;e<w;e+=1){for(r=0;r<_;r+=1)S[r]=R[r]=G[r]=P[r]=k[r]=M[r]=0;for(i=-a;i<=a;i+=1)if(!((h=$+i)<0)&&!(h>=D))for(l=h*w,n=-a;n<=a;n+=1)!((s=e+n)<0)&&!(s>=w)&&(g=p[u=l+s<<2],o=p[u+1],f=p[u+2],c=g*_>>8,m=o*_>>8,d=f*_>>8,P[c]+=g,k[m]+=o,M[d]+=f,S[c]+=1,R[m]+=1,G[d]+=1);for(r=1,F=I=v=0;r<_;r+=1)S[r]>S[F]&&(F=r),R[r]>R[I]&&(I=r),G[r]>G[v]&&(v=r);b[B]=P[F]/S[F]|0,b[B+1]=k[I]/R[I]|0,b[B+2]=M[v]/G[v]|0,b[B+3]=p[B+3],B+=4}return C},ImageFilters.OpacityFilter=function(t,a){for(var _=t.data,e=t.width,$=t.height,r=_.length,i=this.utils.createImageData(e,$),n=i.data,h=0;h<r;h+=4)n[h]=_[h],n[h+1]=_[h+1],n[h+2]=_[h+2],n[h+3]=a;return i},ImageFilters.Posterize=function(t,a){var _,e=t.data,$=t.width,r=t.height,i=(e.length,this.utils.createImageData($,r)),n=i.data,h=[],s=(a=a<2?2:a>255?255:a)-1,l=0,u=0;for(_=0;_<a;_+=1)h[_]=255*_/s;return this.utils.mapRGB(e,n,function(t){var _=h[l];return(u+=a)>255&&(u-=255,l+=1),_}),i},ImageFilters.Rescale=function(t,a){var _=t.data,e=t.width,$=t.height,r=(_.length,this.utils.createImageData(e,$)),i=r.data;return this.utils.mapRGB(_,i,function(t){return(t*=a)>255?255:t+.5|0}),r},ImageFilters.ResizeNearestNeighbor=function(t,a,_){var e,$,r,i,n=t.data,h=t.width,s=t.height,l=(n.length,this.utils.createImageData(a,_)),u=l.data,g=h/a,o=s/_,f=0;for(r=0;r<_;r+=1)for($=0,i=(r*o|0)*h;$<a;$+=1)e=i+$*g<<2,u[f]=n[e],u[f+1]=n[e+1],u[f+2]=n[e+2],u[f+3]=n[e+3],f+=4;return l},ImageFilters.Resize=function(t,a,_){var e,$,r=t.data,i=t.width,n=t.height,h=(r.length,this.utils.createImageData(a,_)),s=h.data,l=i/a,u=n/_,g=0;for($=0;$<_;$+=1)for(e=0;e<a;e+=1)this.utils.copyBilinear(r,e*l,$*u,i,n,s,g,0),g+=4;return h},ImageFilters.ResizeBuiltin=function(t,a,_){var e,$=t.width,r=t.height,i=this.utils.getSampleCanvas(),n=this.utils.getSampleContext();return i.width=Math.max($,a),i.height=Math.max(r,_),n.save(),n.putImageData(t,0,0),n.scale(a/$,_/r),n.drawImage(i,0,0),e=n.getImageData(0,0,a,_),n.restore(),i.width=0,i.height=0,e},ImageFilters.Sepia=function(t){var a,_,e,$,r,i=t.data,n=t.width,h=t.height,s=i.length,l=this.utils.createImageData(n,h),u=l.data;for($=0;$<s;$+=4)a=i[$],_=i[$+1],e=i[$+2],u[$]=(r=.393*a+.769*_+.189*e)>255?255:r<0?0:r+.5|0,u[$+1]=(r=.349*a+.686*_+.168*e)>255?255:r<0?0:r+.5|0,u[$+2]=(r=.272*a+.534*_+.131*e)>255?255:r<0?0:r+.5|0,u[$+3]=i[$+3];return l},ImageFilters.Sharpen=function(t,a){return this.ConvolutionFilter(t,3,3,[-a/16,-a/8,-a/16,-a/8,.75*a+1,-a/8,-a/16,-a/8,-a/16])},ImageFilters.Solarize=function(t){var a=t.data,_=t.width,e=t.height,$=(a.length,this.utils.createImageData(_,e)),r=$.data;return this.utils.mapRGB(a,r,function(t){return t>127?(t-127.5)*2:(127.5-t)*2}),$},ImageFilters.Transpose=function(t){var a,_,e=t.data,$=t.width,r=t.height,i=(e.length,this.utils.createImageData(r,$)),n=i.data;for(y=0;y<r;y+=1)for(x=0;x<$;x+=1)a=y*$+x<<2,n[_=x*r+y<<2]=e[a],n[_+1]=e[a+1],n[_+2]=e[a+2],n[_+3]=e[a+3];return i},ImageFilters.Twril=function(t,a,_,e,$,r,i){var n=t.data,h=t.width,s=t.height,l=(n.length,this.utils.createImageData(h,s)),u=l.data;a*=h,_*=s,$*=Math.PI/180;var g,o,f,c,m,d,F,I,v,p=e*e,w=0;for(o=0;o<s;o+=1)for(g=0;g<h;g+=1)(m=(f=g-a)*f+(c=o-_)*c)>p?(u[w]=n[w],u[w+1]=n[w+1],u[w+2]=n[w+2],u[w+3]=n[w+3]):(d=Math.atan2(c,f)+$*(e-(m=Math.sqrt(m)))/e,F=a+m*Math.cos(d),I=_+m*Math.sin(d),i?this.utils.copyBilinear(n,F,I,h,s,u,w,r):(v=(I+.5|0)*h+(F+.5|0)<<2,u[w]=n[v],u[w+1]=n[v+1],u[w+2]=n[v+2],u[w+3]=n[v+3])),w+=4;return l};